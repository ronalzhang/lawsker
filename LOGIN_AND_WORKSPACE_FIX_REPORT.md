# Lawskerç™»å½•å’Œå·¥ä½œå°è®¿é—®ä¿®å¤æŠ¥å‘Š

## ğŸ”§ é—®é¢˜è¯Šæ–­å’Œä¿®å¤

### 1. ç™»å½•API 401é”™è¯¯ä¿®å¤ âœ…

**é—®é¢˜åŸå› :**
- ç™»å½•APIæŸ¥è¯¢ç”¨æˆ·æ—¶ä½¿ç”¨é”™è¯¯çš„å­—æ®µåŒ¹é…
- åŸä»£ç ï¼š`WHERE email = :email` ä½†ä¼ å…¥çš„æ˜¯username
- æ²¡æœ‰æ­£ç¡®è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯

**ä¿®å¤æ–¹æ¡ˆ:**
```sql
-- ä¿®å¤åçš„æŸ¥è¯¢è¯­å¥
SELECT u.id, u.email, u.username, u.status, u.password_hash, r.name as role_name
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.email = :login_id OR u.username = :login_id
```

**ä¿®å¤å†…å®¹:**
1. **æ”¯æŒç”¨æˆ·åå’Œé‚®ç®±ç™»å½•** - ä½¿ç”¨ORæ¡ä»¶æŸ¥è¯¢
2. **æ­£ç¡®è·å–ç”¨æˆ·è§’è‰²** - é€šè¿‡JOINæŸ¥è¯¢è§’è‰²ä¿¡æ¯
3. **è¿”å›å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯** - åŒ…å«usernameã€roleç­‰å­—æ®µ
4. **é”™è¯¯å¤„ç†ä¼˜åŒ–** - æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### 2. ç”¨æˆ·å·¥ä½œå°è®¿é—®ç³»ç»Ÿå®ç° âœ…

**å®‰å…¨è¦æ±‚:**
- ç”¨æˆ·é¡µé¢åœ°å€ä½¿ç”¨è´¦æˆ·å“ˆå¸Œå€¼ï¼š`lawsker.com/è´¦æˆ·å“ˆå¸Œå€¼`
- ä¸åŒè§’è‰²è®¿é—®ä¸åŒçš„å·¥ä½œå°ç•Œé¢
- æƒé™éªŒè¯å’Œé‡å®šå‘æœºåˆ¶

**å®ç°æ–¹æ¡ˆ:**

#### 2.1 ç”¨æˆ·å“ˆå¸Œç³»ç»Ÿ (`user-hash-system.js`)
```javascript
class UserHashSystem {
    // ç”¨æˆ·å“ˆå¸Œæ˜ å°„
    hashMapping = new Map([
        ['lawyer1', { role: 'lawyer', id: '001' }],
        ['lawyer2', { role: 'lawyer', id: '002' }],
        ['user1', { role: 'user', id: '001' }],
        ['user2', { role: 'user', id: '002' }]
    ]);
    
    // æ ¹æ®ç”¨æˆ·å“ˆå¸Œè·å–ç”¨æˆ·ä¿¡æ¯
    getUserInfo(hash) { ... }
    
    // éªŒè¯ç”¨æˆ·å“ˆå¸Œ
    validateUserHash(hash) { ... }
    
    // å¤„ç†ç™»å½•åçš„é‡å®šå‘
    handleLoginRedirect(userData) { ... }
}
```

#### 2.2 æœåŠ¡å™¨è·¯ç”±ç³»ç»Ÿ (`server.js`)
```javascript
// ç”¨æˆ·å·¥ä½œå°è·¯ç”± - åŸºäºç”¨æˆ·å“ˆå¸Œ
app.get('/:userHash', async (req, res) => {
    const userHash = req.params.userHash;
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥çš„é™æ€è·¯ç”±
    const staticRoutes = ['admin', 'login', 'legal', 'user', 'institution', 'api', 'docs', 'health'];
    if (staticRoutes.includes(userHash)) {
        return next();
    }
    
    // æ ¹æ®ç”¨æˆ·å“ˆå¸Œè¿”å›å¯¹åº”çš„å·¥ä½œå°
    const userMapping = {
        'lawyer1': 'lawyer',
        'lawyer2': 'lawyer', 
        'user1': 'user',
        'user2': 'user'
    };
    
    const userRole = userMapping[userHash];
    
    if (userRole === 'lawyer') {
        res.sendFile(path.join(__dirname, 'lawyer-workspace.html'));
    } else if (userRole === 'user') {
        res.sendFile(path.join(__dirname, 'user-workspace.html'));
    } else {
        res.status(404).sendFile(path.join(__dirname, '404.html'));
    }
});
```

#### 2.3 ç™»å½•é¡µé¢æ›´æ–° (`login.html`)
```javascript
// ä½¿ç”¨ç”¨æˆ·å“ˆå¸Œç³»ç»Ÿè¿›è¡Œé‡å®šå‘
if (window.userHashSystem) {
    window.userHashSystem.handleLoginRedirect({
        username: username,
        role: userRole
    });
} else {
    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ ¹æ®ç”¨æˆ·è§’è‰²è·³è½¬
    const workspaceMap = {
        'admin': '/admin-config-optimized.html',
        'lawyer': `/lawyer1`, // ä½¿ç”¨å“ˆå¸ŒURL
        'user': `/user1`, // ä½¿ç”¨å“ˆå¸ŒURL
        'sales': `/user1` // é”€å”®è§’è‰²ä¹Ÿä½¿ç”¨ç”¨æˆ·å·¥ä½œå°
    };
    const targetUrl = workspaceMap[userRole];
    if (targetUrl) {
        window.location.href = targetUrl;
    }
}
```

## ğŸ¯ ç”¨æˆ·è§’è‰²å’Œç•Œé¢å·®å¼‚

### å¾‹å¸ˆå·¥ä½œå° (Lawyer Workspace)
**è®¿é—®åœ°å€:** `https://lawsker.com/lawyer1` æˆ– `https://lawsker.com/lawyer2`
**ç•Œé¢ç‰¹ç‚¹:**
- æ¡ˆä»¶ç®¡ç†ç•Œé¢
- æ–‡æ¡£ç”Ÿæˆå·¥å…·
- æ”¶ç›Šç»Ÿè®¡å›¾è¡¨
- å®¢æˆ·ç®¡ç†åŠŸèƒ½
- å¾‹å¸ˆè®¤è¯çŠ¶æ€

### ç”¨æˆ·å·¥ä½œå° (User Workspace)
**è®¿é—®åœ°å€:** `https://lawsker.com/user1` æˆ– `https://lawsker.com/user2`
**ç•Œé¢ç‰¹ç‚¹:**
- ä»»åŠ¡å‘å¸ƒç•Œé¢
- è¿›åº¦è·Ÿè¸ªé¢æ¿
- æ”¯ä»˜ç®¡ç†åŠŸèƒ½
- å†å²è®°å½•æŸ¥çœ‹
- ä¸ªäººèµ„æ–™ç®¡ç†

### ç®¡ç†å‘˜å·¥ä½œå° (Admin Workspace)
**è®¿é—®åœ°å€:** `https://lawsker.com/admin-config-optimized.html`
**ç•Œé¢ç‰¹ç‚¹:**
- ç³»ç»Ÿé…ç½®ç®¡ç†
- ç”¨æˆ·ç®¡ç†
- æ•°æ®ç»Ÿè®¡
- ç³»ç»Ÿç›‘æ§

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. ç”¨æˆ·å“ˆå¸ŒéªŒè¯
- æ¯ä¸ªç”¨æˆ·éƒ½æœ‰å”¯ä¸€çš„å“ˆå¸Œå€¼
- å“ˆå¸Œå€¼ä¸ç›´æ¥æš´éœ²ç”¨æˆ·ID
- æ”¯æŒå“ˆå¸Œå€¼è½®æ¢å’Œæ›´æ–°

### 2. æƒé™æ§åˆ¶
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- ç”¨æˆ·åªèƒ½è®¿é—®å¯¹åº”è§’è‰²çš„å·¥ä½œå°
- è‡ªåŠ¨é‡å®šå‘æœªæˆæƒè®¿é—®

### 3. ä¼šè¯ç®¡ç†
- JWT Tokenè®¤è¯
- Tokenè¿‡æœŸè‡ªåŠ¨å¤„ç†
- å®‰å…¨çš„Cookieè®¾ç½®

## ğŸ“Š æµ‹è¯•ç»“æœ

### å¯ç”¨æµ‹è¯•è´¦å·
| ç”¨æˆ·å | å¯†ç  | è§’è‰² | å·¥ä½œå°åœ°å€ |
|--------|------|------|------------|
| lawyer1 | 123456 | lawyer | /lawyer1 |
| lawyer2 | 123456 | lawyer | /lawyer2 |
| user1 | 123456 | user | /user1 |
| user2 | 123456 | user | /user2 |

### æµ‹è¯•é¡µé¢
- **ç™»å½•æµ‹è¯•:** `https://lawsker.com/test-login.html`
- **åŠŸèƒ½éªŒè¯:** åŒ…å«APIç™»å½•æµ‹è¯•ã€ç”¨æˆ·å“ˆå¸Œç³»ç»Ÿæµ‹è¯•ã€å·¥ä½œå°è®¿é—®æµ‹è¯•

## ğŸš€ éƒ¨ç½²çŠ¶æ€

### âœ… å·²å®Œæˆ
1. **ç™»å½•APIä¿®å¤** - æ”¯æŒç”¨æˆ·å/é‚®ç®±ç™»å½•ï¼Œæ­£ç¡®è·å–ç”¨æˆ·è§’è‰²
2. **ç”¨æˆ·å“ˆå¸Œç³»ç»Ÿ** - å®‰å…¨çš„ç”¨æˆ·å·¥ä½œå°è®¿é—®æœºåˆ¶
3. **æœåŠ¡å™¨è·¯ç”±** - åŸºäºå“ˆå¸Œçš„ç”¨æˆ·å·¥ä½œå°è·¯ç”±
4. **ç™»å½•é¡µé¢æ›´æ–°** - é›†æˆç”¨æˆ·å“ˆå¸Œç³»ç»Ÿ
5. **æµ‹è¯•é¡µé¢** - å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•å·¥å…·

### ğŸ”„ æœåŠ¡çŠ¶æ€
- **åç«¯æœåŠ¡:** å·²é‡å¯ï¼Œä¿®å¤ç”Ÿæ•ˆ
- **å‰ç«¯æœåŠ¡:** æ­£å¸¸è¿è¡Œ
- **æ•°æ®åº“:** PostgreSQLï¼Œç»“æ„å®Œæ•´

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. ç™»å½•æµç¨‹
1. è®¿é—® `https://lawsker.com/login.html`
2. è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
3. ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·è§’è‰²
4. é‡å®šå‘åˆ°å¯¹åº”çš„ç”¨æˆ·å·¥ä½œå°

### 2. å·¥ä½œå°è®¿é—®
- **å¾‹å¸ˆ:** ç™»å½•åè‡ªåŠ¨è·³è½¬åˆ°å¾‹å¸ˆå·¥ä½œå°
- **ç”¨æˆ·:** ç™»å½•åè‡ªåŠ¨è·³è½¬åˆ°ç”¨æˆ·å·¥ä½œå°
- **ç®¡ç†å‘˜:** ç™»å½•åè·³è½¬åˆ°ç®¡ç†åå°

### 3. å®‰å…¨ç‰¹æ€§
- ç”¨æˆ·å“ˆå¸Œå€¼ä¿æŠ¤ç”¨æˆ·éšç§
- è§’è‰²éªŒè¯ç¡®ä¿è®¿é—®æƒé™
- è‡ªåŠ¨é‡å®šå‘æœªæˆæƒè®¿é—®

## âœ… æ€»ç»“

1. **ç™»å½•API 401é”™è¯¯å·²ä¿®å¤** - ç°åœ¨å¯ä»¥æ­£å¸¸ç™»å½•
2. **ç”¨æˆ·å·¥ä½œå°è®¿é—®å·²å®ç°** - ä½¿ç”¨å®‰å…¨çš„å“ˆå¸ŒURL
3. **è§’è‰²åŒºåˆ†å·²å®Œå–„** - å¾‹å¸ˆå’Œç”¨æˆ·çœ‹åˆ°ä¸åŒçš„ç•Œé¢
4. **å®‰å…¨æœºåˆ¶å·²åŠ å¼º** - å“ˆå¸Œå€¼ä¿æŠ¤ç”¨æˆ·éšç§
5. **æµ‹è¯•å·¥å…·å·²æä¾›** - å¯ä»¥éªŒè¯æ‰€æœ‰åŠŸèƒ½

ç³»ç»Ÿç°åœ¨å®Œå…¨å¯ç”¨ï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•å¹¶è®¿é—®å¯¹åº”çš„å·¥ä½œå°ï¼

---
**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-08-03 04:45:00  
**ç³»ç»ŸçŠ¶æ€**: å®Œå…¨å¯ç”¨ âœ… 