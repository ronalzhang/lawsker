<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘é€è®°å½•ç®¡ç† - å¾‹æ€å®¢å¹³å°</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .send-record-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .send-record-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .record-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .record-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .method-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .method-tag {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .method-email {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .method-sms {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }

        .method-mail {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            border: 1px solid #8b5cf6;
        }

        .status-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .status-btn.sent {
            background: #10b981;
            color: white;
        }

        .status-btn.pending {
            background: #f59e0b;
            color: white;
        }

        .status-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .tracking-input {
            margin-top: 8px;
            padding: 8px;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            width: 200px;
            font-size: 12px;
        }

        .update-form {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        .update-form.active {
            display: block;
        }

        .filter-bar {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-primary);
            font-size: 14px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¤ å‘é€è®°å½•ç®¡ç†</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="history.back()">è¿”å›å·¥ä½œå°</button>
                <button class="btn btn-primary" onclick="refreshRecords()">åˆ·æ–°è®°å½•</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" id="totalRecords">0</div>
                <div class="stat-label">æ€»å‘é€è®°å½•</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="emailSent">0</div>
                <div class="stat-label">é‚®ä»¶å·²å‘é€</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="smsPending">0</div>
                <div class="stat-label">çŸ­ä¿¡å¾…å¤„ç†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="mailPending">0</div>
                <div class="stat-label">æŒ‚å·ä¿¡å¾…å¤„ç†</div>
            </div>
        </div>

        <!-- ç­›é€‰æ  -->
        <div class="filter-bar">
            <label>ç­›é€‰æ¡ä»¶ï¼š</label>
            <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="pending">å¾…å¤„ç†</option>
                <option value="sent">å·²å¤„ç†</option>
            </select>
            <select class="filter-select" id="methodFilter" onchange="applyFilters()">
                <option value="">å…¨éƒ¨æ–¹å¼</option>
                <option value="email">é‚®ä»¶</option>
                <option value="sms">çŸ­ä¿¡</option>
                <option value="registered_mail">æŒ‚å·ä¿¡</option>
            </select>
            <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
        </div>

        <!-- å‘é€è®°å½•åˆ—è¡¨ -->
        <div id="recordsContainer">
            <!-- åŠ¨æ€åŠ è½½å‘é€è®°å½• -->
        </div>

        <!-- åŠ è½½æ›´å¤š -->
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-secondary" id="loadMoreBtn" onclick="loadMoreRecords()">åŠ è½½æ›´å¤š</button>
        </div>
    </div>

    <!-- çŠ¶æ€æ›´æ–°æ¨¡æ€æ¡† -->
    <div id="updateModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ğŸ“ æ›´æ–°å‘é€çŠ¶æ€</h3>
                <span class="close" onclick="closeUpdateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">å‘é€æ–¹å¼</label>
                    <input type="text" id="updateMethod" readonly style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); border-radius: 6px; background: #f5f5f5;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">å‘é€çŠ¶æ€</label>
                    <select id="updateStatus" style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); border-radius: 6px;">
                        <option value="false">å¾…å‘é€</option>
                        <option value="true">å·²å‘é€</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 16px;" id="trackingNumberDiv">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">å¿«é€’å•å·ï¼ˆæŒ‚å·ä¿¡ï¼‰</label>
                    <input type="text" id="updateTrackingNumber" placeholder="è¯·è¾“å…¥å¿«é€’å•å·" style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); border-radius: 6px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">å¤‡æ³¨</label>
                    <textarea id="updateNotes" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" rows="3" style="width: 100%; padding: 8px; border: 1px solid var(--glass-border); border-radius: 6px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUpdateModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitStatusUpdate()">ç¡®è®¤æ›´æ–°</button>
            </div>
        </div>
    </div>

    <script src="api-client.js"></script>
    <script>
        let currentRecords = [];
        let currentPage = 0;
        let isLoading = false;
        let currentUpdateRecordId = null;
        let currentUpdateMethod = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSendRecords();
        });

        // åŠ è½½å‘é€è®°å½•
        async function loadSendRecords(page = 0, append = false) {
            if (isLoading) return;
            isLoading = true;

            try {
                const response = await fetch(`https://156.236.74.200/api/v1/document-send/send-records?limit=10&offset=${page * 10}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    if (append) {
                        currentRecords = [...currentRecords, ...result.records];
                    } else {
                        currentRecords = result.records;
                    }
                    
                    renderRecords();
                    updateStats();
                    
                    // æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®
                    const loadMoreBtn = document.getElementById('loadMoreBtn');
                    if (result.has_more) {
                        loadMoreBtn.style.display = 'block';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                } else {
                    showNotification('åŠ è½½å‘é€è®°å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å‘é€è®°å½•å¤±è´¥:', error);
                showNotification('åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                isLoading = false;
            }
        }

        // æ¸²æŸ“å‘é€è®°å½•
        function renderRecords() {
            const container = document.getElementById('recordsContainer');
            
            if (currentRecords.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
                        <h3>æš‚æ— å‘é€è®°å½•</h3>
                        <p>å½“æ‚¨å‘é€æ–‡ä¹¦åï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentRecords.map(record => {
                const methods = record.send_methods || [];
                const methodTags = methods.map(method => {
                    const methodInfo = getMethodInfo(method);
                    return `<span class="method-tag method-${methodInfo.type}">${methodInfo.icon} ${methodInfo.name}</span>`;
                }).join('');

                return `
                    <div class="send-record-item" data-record-id="${record.id}">
                        <div class="record-header">
                            <div>
                                <div class="record-title">${record.document_title || 'æœªçŸ¥æ–‡ä¹¦'}</div>
                                <div class="record-meta">
                                    æ”¶ä»¶äººï¼š${record.recipient_name} | 
                                    å‘é€æ—¶é—´ï¼š${new Date(record.created_at).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="method-tags">
                            ${methodTags}
                        </div>
                        
                        ${renderMethodActions(record)}
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“æ–¹å¼æ“ä½œæŒ‰é’®
        function renderMethodActions(record) {
            const methods = record.send_methods || [];
            
            return methods.map(method => {
                if (method === 'email') {
                    return `
                        <div style="margin-bottom: 8px;">
                            <span style="color: #10b981; font-weight: 500;">ğŸ“§ é‚®ä»¶ï¼š</span>
                            <span style="color: #10b981;">å·²è‡ªåŠ¨å‘é€</span>
                        </div>
                    `;
                } else if (method === 'sms') {
                    const status = getSendStatus(record, 'sms');
                    return `
                        <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <span style="color: #f59e0b; font-weight: 500;">ğŸ“± çŸ­ä¿¡ï¼š</span>
                            <button class="status-btn ${status ? 'sent' : 'pending'}" 
                                    onclick="openUpdateModal('${record.id}', 'sms')">
                                ${status ? 'å·²å‘é€' : 'å¾…å‘é€'}
                            </button>
                        </div>
                    `;
                } else if (method === 'registered_mail') {
                    const status = getSendStatus(record, 'registered_mail');
                    const trackingNumber = getTrackingNumber(record);
                    return `
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="color: #8b5cf6; font-weight: 500;">ğŸ“® æŒ‚å·ä¿¡ï¼š</span>
                                <button class="status-btn ${status ? 'sent' : 'pending'}" 
                                        onclick="openUpdateModal('${record.id}', 'registered_mail')">
                                    ${status ? 'å·²å¯„é€' : 'å¾…å¯„é€'}
                                </button>
                            </div>
                            ${trackingNumber ? `<div style="font-size: 12px; color: #8b5cf6;">å¿«é€’å•å·ï¼š${trackingNumber}</div>` : ''}
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        // è·å–æ–¹å¼ä¿¡æ¯
        function getMethodInfo(method) {
            const methodMap = {
                'email': { type: 'email', icon: 'ğŸ“§', name: 'é‚®ä»¶' },
                'sms': { type: 'sms', icon: 'ğŸ“±', name: 'çŸ­ä¿¡' },
                'registered_mail': { type: 'mail', icon: 'ğŸ“®', name: 'æŒ‚å·ä¿¡' }
            };
            return methodMap[method] || { type: 'unknown', icon: 'â“', name: method };
        }

        // è·å–å‘é€çŠ¶æ€
        function getSendStatus(record, method) {
            const sendStatus = record.send_status || '';
            return sendStatus.includes(`${method}:sent`);
        }

        // è·å–å¿«é€’å•å·
        function getTrackingNumber(record) {
            return record.tracking_number || '';
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const totalRecords = currentRecords.length;
            let emailSent = 0;
            let smsPending = 0;
            let mailPending = 0;

            currentRecords.forEach(record => {
                const methods = record.send_methods || [];
                
                if (methods.includes('email')) {
                    emailSent++;
                }
                if (methods.includes('sms') && !getSendStatus(record, 'sms')) {
                    smsPending++;
                }
                if (methods.includes('registered_mail') && !getSendStatus(record, 'registered_mail')) {
                    mailPending++;
                }
            });

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('emailSent').textContent = emailSent;
            document.getElementById('smsPending').textContent = smsPending;
            document.getElementById('mailPending').textContent = mailPending;
        }

        // åˆ·æ–°è®°å½•
        function refreshRecords() {
            currentPage = 0;
            loadSendRecords(0, false);
        }

        // åŠ è½½æ›´å¤šè®°å½•
        function loadMoreRecords() {
            currentPage++;
            loadSendRecords(currentPage, true);
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const methodFilter = document.getElementById('methodFilter').value;
            
            // è¿™é‡Œå¯ä»¥å®ç°ç­›é€‰é€»è¾‘
            // æš‚æ—¶å…ˆåˆ·æ–°è®°å½•
            refreshRecords();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('methodFilter').value = '';
            refreshRecords();
        }

        // æ‰“å¼€æ›´æ–°æ¨¡æ€æ¡†
        function openUpdateModal(recordId, method) {
            currentUpdateRecordId = recordId;
            currentUpdateMethod = method;

            const record = currentRecords.find(r => r.id === recordId);
            if (!record) return;

            const methodNames = {
                'sms': 'çŸ­ä¿¡å‘é€',
                'registered_mail': 'æŒ‚å·ä¿¡å¯„é€'
            };

            document.getElementById('updateMethod').value = methodNames[method] || method;
            document.getElementById('updateStatus').value = getSendStatus(record, method) ? 'true' : 'false';
            document.getElementById('updateTrackingNumber').value = method === 'registered_mail' ? getTrackingNumber(record) : '';
            document.getElementById('updateNotes').value = '';

            // æ˜¾ç¤º/éšè—å¿«é€’å•å·è¾“å…¥æ¡†
            const trackingDiv = document.getElementById('trackingNumberDiv');
            trackingDiv.style.display = method === 'registered_mail' ? 'block' : 'none';

            document.getElementById('updateModal').style.display = 'block';
        }

        // å…³é—­æ›´æ–°æ¨¡æ€æ¡†
        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
            currentUpdateRecordId = null;
            currentUpdateMethod = null;
        }

        // æäº¤çŠ¶æ€æ›´æ–°
        async function submitStatusUpdate() {
            if (!currentUpdateRecordId || !currentUpdateMethod) return;

            const isSent = document.getElementById('updateStatus').value === 'true';
            const trackingNumber = document.getElementById('updateTrackingNumber').value;
            const notes = document.getElementById('updateNotes').value;

            try {
                const response = await fetch(`https://156.236.74.200/api/v1/document-send/update-send-status`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        send_record_id: currentUpdateRecordId,
                        method: currentUpdateMethod,
                        is_sent: isSent,
                        tracking_number: trackingNumber || null,
                        sent_time: isSent ? new Date().toISOString() : null,
                        notes: notes || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('å‘é€çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
                    closeUpdateModal();
                    refreshRecords();
                } else {
                    showNotification('æ›´æ–°å¤±è´¥ï¼š' + result.message, 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°å‘é€çŠ¶æ€å¤±è´¥:', error);
                showNotification('æ›´æ–°å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // ç®€å•çš„é€šçŸ¥å®ç°
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;

            const colors = {
                'success': '#10b981',
                'error': '#ef4444',
                'warning': '#f59e0b',
                'info': '#3b82f6'
            };

            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>