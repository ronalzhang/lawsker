<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾‹å¸ˆè®¤è¯ - å¾‹æ€å®¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/lawsker-glass.css" rel="stylesheet">
    <style>
        .certification-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #f0f4ff;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
            color: #f0f4ff;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: #6c757d;
            font-weight: bold;
        }
        
        .step.active .step-circle {
            background: #007bff;
            color: white;
        }
        
        .step.completed .step-circle {
            background: #28a745;
            color: white;
        }
        
        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            color: var(--text-primary);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 16px var(--glass-shadow);
        }
        
        .upload-area:hover {
            border-color: rgba(122, 160, 255, 0.6);
            background: rgba(22, 28, 48, 0.85);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--glass-shadow);
        }
        
        .upload-area.dragover {
            border-color: rgba(16, 185, 129, 0.6);
            background: rgba(22, 28, 48, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }
        
        .preview-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .extraction-result {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            color: var(--text-primary);
            box-shadow: 0 4px 16px var(--glass-shadow);
        }
        
        .confidence-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }
        
        .info-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 8px 32px var(--glass-shadow);
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        
        .ai-tips {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--text-primary);
        }
        
        .spinner-border {
            color: #3b82f6;
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .field-status {
            font-size: 12px;
            margin-left: 5px;
        }
        
        .field-valid { color: #10b981; }
        .field-invalid { color: #ef4444; }
        .field-extracted { color: #3b82f6; }
        
        /* æ·±è‰²ä¸»é¢˜Alertæ ·å¼ */
        .alert {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
            color: var(--text-primary);
            box-shadow: 0 4px 16px var(--glass-shadow);
        }
        
        .alert-info {
            border-left: 3px solid #3b82f6;
        }
        
        .alert-primary {
            border-left: 3px solid #7c3aed;
        }
        
        .alert-success {
            border-left: 3px solid #10b981;
        }
        
        .alert-danger {
            border-left: 3px solid #ef4444;
        }
        
        .alert-warning {
            border-left: 3px solid #f59e0b;
        }
        
        /* æ·±è‰²ä¸»é¢˜è¡¨å•æ§ä»¶æ ·å¼ */
        .form-control, .form-select {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: rgba(122, 160, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(122, 160, 255, 0.1);
            background: rgba(22, 28, 48, 0.85);
            outline: none;
        }
        
        .form-control::placeholder {
            color: var(--text-muted);
        }
        
        .form-label {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-check-input {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        
        .form-check-input:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        .form-check-label {
            color: var(--text-primary);
        }
        
        .text-muted {
            color: var(--text-muted) !important;
        }
        
        .text-primary {
            color: #3b82f6 !important;
        }
        
        .text-success {
            color: #10b981 !important;
        }
        
        .text-danger {
            color: #ef4444 !important;
        }
        
        /* æ·±è‰²ä¸»é¢˜æŒ‰é’®æ ·å¼ */
        .btn {
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-radius));
            -webkit-backdrop-filter: blur(var(--blur-radius));
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            box-shadow: 0 4px 16px var(--glass-shadow);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--glass-shadow);
            background: rgba(22, 28, 48, 0.85);
        }
        
        .btn-outline-primary {
            background: transparent;
            border: 2px solid #3b82f6;
            color: #3b82f6;
        }
        
        .btn-outline-primary:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
    </style>
</head>
<body>
    <div class="certification-container">
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <span>ä¸Šä¼ å¾‹å¸ˆè¯</span>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <span>AIè¯†åˆ«</span>
            </div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <span>ä¿¡æ¯ç¡®è®¤</span>
            </div>
            <div class="step" id="step4">
                <div class="step-circle">4</div>
                <span>æäº¤è®¤è¯</span>
            </div>
        </div>

        <!-- AIåŠŸèƒ½ä»‹ç» -->
        <div class="ai-tips">
            <h5><i class="fas fa-robot"></i> AIæ™ºèƒ½è¯†åˆ«åŠŸèƒ½</h5>
            <p class="mb-2">æˆ‘ä»¬çš„AIç³»ç»Ÿå¯ä»¥è‡ªåŠ¨è¯†åˆ«å¾‹å¸ˆè¯ä¸Šçš„å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š</p>
            <div class="row">
                <div class="col-md-6">
                    <ul class="mb-0">
                        <li>æ‰§ä¸šè¯å·</li>
                        <li>å¾‹å¸ˆå§“å</li>
                        <li>æ€§åˆ«</li>
                        <li>èº«ä»½è¯å·</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="mb-0">
                        <li>å‘è¯æœºå…³</li>
                        <li>å‘è¯æ—¥æœŸ</li>
                        <li>å¾‹å¸ˆäº‹åŠ¡æ‰€</li>
                        <li>æ‰§ä¸šå¹´é™ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</li>
                    </ul>
                </div>
            </div>
            <p class="mt-2 mb-0"><small><i class="fas fa-info-circle"></i> è¯·ç¡®ä¿å¾‹å¸ˆè¯å›¾ç‰‡æ¸…æ™°ï¼Œé¿å…åå…‰å’Œé˜´å½±</small></p>
        </div>

        <!-- ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å¾‹å¸ˆè¯ -->
        <div class="form-section active" id="section1">
            <div class="info-card">
                <h4><i class="fas fa-upload"></i> ä¸Šä¼ å¾‹å¸ˆæ‰§ä¸šè¯ä¹¦</h4>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                    <h5>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å¾‹å¸ˆè¯å›¾ç‰‡</h5>
                    <p class="text-muted">æ”¯æŒ JPGã€PNGã€BMP æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB</p>
                    <input type="file" id="licenseFile" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('licenseFile').click()">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                </div>
                
                <div id="imagePreview" class="text-center mt-3" style="display: none;">
                    <img id="previewImg" class="preview-image" alt="å¾‹å¸ˆè¯é¢„è§ˆ">
                    <div class="mt-2">
                        <button type="button" class="btn btn-success" id="analyzeBtn">
                            <i class="fas fa-magic"></i> å¼€å§‹AIè¯†åˆ«
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetUpload()">
                            é‡æ–°ä¸Šä¼ 
                        </button>
                    </div>
                </div>
                
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">AIè¯†åˆ«ä¸­...</span>
                    </div>
                    <p class="mt-2">AIæ­£åœ¨è¯†åˆ«å¾‹å¸ˆè¯ä¿¡æ¯ï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šAIè¯†åˆ«ç»“æœ -->
        <div class="form-section" id="section2">
            <div class="info-card">
                <h4><i class="fas fa-brain"></i> AIè¯†åˆ«ç»“æœ</h4>
                
                <div id="extractionResult" class="extraction-result">
                    <!-- AIè¯†åˆ«ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary" id="confirmExtractionBtn">
                        ç¡®è®¤è¯†åˆ«ç»“æœ
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="goToStep(1)">
                        é‡æ–°è¯†åˆ«
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰æ­¥ï¼šä¿¡æ¯ç¡®è®¤å’Œè¡¥å…… -->
        <div class="form-section" id="section3">
            <div class="info-card">
                <h4><i class="fas fa-edit"></i> ç¡®è®¤å¹¶å®Œå–„ä¿¡æ¯</h4>
                <p class="text-muted">è¯·æ ¸å¯¹AIè¯†åˆ«çš„ä¿¡æ¯ï¼Œå¹¶è¡¥å……æˆ–ä¿®æ­£ä¸å‡†ç¡®çš„å†…å®¹</p>
                
                <form id="certificationForm">
                    <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
                    <div class="alert alert-info mb-3">
                        <h6><i class="fas fa-user"></i> ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</h6>
                        <small>å®Œå–„æ‚¨çš„åŸºæœ¬ä¿¡æ¯ï¼Œç”¨äºè´¦å·è®¤è¯å’Œè”ç³»</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    çœŸå®å§“å <span class="text-danger">*</span>
                                    <span class="field-status" id="fullNameStatus"></span>
                                </label>
                                <input type="text" class="form-control" id="fullName" required placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    é‚®ç®±åœ°å€ <span class="text-danger">*</span>
                                    <span class="field-status" id="emailStatus"></span>
                                </label>
                                <input type="email" class="form-control" id="email" required placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€">
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¾‹å¸ˆæ‰§ä¸šä¿¡æ¯ -->
                    <div class="alert alert-primary mb-3">
                        <h6><i class="fas fa-balance-scale"></i> å¾‹å¸ˆæ‰§ä¸šä¿¡æ¯</h6>
                        <small>è¯·æ ¸å¯¹AIè¯†åˆ«çš„ä¿¡æ¯ï¼Œå¹¶è¡¥å……æˆ–ä¿®æ­£ä¸å‡†ç¡®çš„å†…å®¹</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    å¾‹å¸ˆå§“å <span class="text-danger">*</span>
                                    <span class="field-status" id="nameStatus"></span>
                                </label>
                                <input type="text" class="form-control" id="lawyerName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    æ€§åˆ«
                                    <span class="field-status" id="genderStatus"></span>
                                </label>
                                <select class="form-select" id="gender">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    æ‰§ä¸šè¯å· <span class="text-danger">*</span>
                                    <span class="field-status" id="licenseStatus"></span>
                                </label>
                                <input type="text" class="form-control" id="licenseNumber" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    èº«ä»½è¯å·
                                    <span class="field-status" id="idCardStatus"></span>
                                </label>
                                <input type="text" class="form-control" id="idCardNumber">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    å‘è¯æœºå…³ <span class="text-danger">*</span>
                                    <span class="field-status" id="authorityStatus"></span>
                                </label>
                                <input type="text" class="form-control" id="licenseAuthority" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    å‘è¯æ—¥æœŸ <span class="text-danger">*</span>
                                    <span class="field-status" id="dateStatus"></span>
                                </label>
                                <input type="date" class="form-control" id="issueDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            å¾‹å¸ˆäº‹åŠ¡æ‰€ <span class="text-danger">*</span>
                            <span class="field-status" id="firmStatus"></span>
                        </label>
                        <input type="text" class="form-control" id="lawFirm" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">æ‰§ä¸šå¹´é™</label>
                                <input type="number" class="form-control" id="yearsOfPractice" readonly>
                                <small class="text-muted">æ ¹æ®å‘è¯æ—¥æœŸè‡ªåŠ¨è®¡ç®—</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">AIè¯†åˆ«ç½®ä¿¡åº¦</label>
                                <div>
                                    <span id="confidenceBadge" class="confidence-badge">--</span>
                                    <span id="confidenceScore" class="ms-2">-- åˆ†</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æ‰§ä¸šé¢†åŸŸ</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="æ°‘å•†äº‹è¯‰è®¼" id="area1">
                                    <label class="form-check-label" for="area1">æ°‘å•†äº‹è¯‰è®¼</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="å€ºæƒå€ºåŠ¡" id="area2">
                                    <label class="form-check-label" for="area2">å€ºæƒå€ºåŠ¡</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="åˆåŒçº çº·" id="area3">
                                    <label class="form-check-label" for="area3">åˆåŒçº çº·</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="å…¬å¸æ³•åŠ¡" id="area4">
                                    <label class="form-check-label" for="area4">å…¬å¸æ³•åŠ¡</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="çŸ¥è¯†äº§æƒ" id="area5">
                                    <label class="form-check-label" for="area5">çŸ¥è¯†äº§æƒ</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="åŠ³åŠ¨äº‰è®®" id="area6">
                                    <label class="form-check-label" for="area6">åŠ³åŠ¨äº‰è®®</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="æˆ¿åœ°äº§" id="area7">
                                    <label class="form-check-label" for="area7">æˆ¿åœ°äº§</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="åˆ‘äº‹è¾©æŠ¤" id="area8">
                                    <label class="form-check-label" for="area8">åˆ‘äº‹è¾©æŠ¤</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="å…¶ä»–" id="area9">
                                    <label class="form-check-label" for="area9">å…¶ä»–</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary" id="submitCertificationBtn">
                        <i class="fas fa-paper-plane"></i> æäº¤è®¤è¯ç”³è¯·
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="goToStep(2)">
                        è¿”å›ä¸Šä¸€æ­¥
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¬¬å››æ­¥ï¼šæäº¤æˆåŠŸ -->
        <div class="form-section" id="section4">
            <div class="info-card text-center">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4>è®¤è¯ç”³è¯·æäº¤æˆåŠŸï¼</h4>
                <p class="text-muted">æ‚¨çš„å¾‹å¸ˆè®¤è¯ç”³è¯·å·²æäº¤ï¼Œæˆ‘ä»¬å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå®¡æ ¸ã€‚</p>
                
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle"></i> åç»­æµç¨‹</h6>
                    <ul class="text-start mb-0">
                        <li>ç®¡ç†å‘˜å°†å®¡æ ¸æ‚¨æäº¤çš„è®¤è¯ä¿¡æ¯</li>
                        <li>å¦‚éœ€è¡¥å……ææ–™ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡é‚®ä»¶è”ç³»æ‚¨</li>
                        <li>å®¡æ ¸é€šè¿‡åï¼Œæ‚¨å°†è·å¾—å¾‹å¸ˆæƒé™</li>
                        <li>å¯ä»¥å¼€å§‹æ¥æ”¶å’Œå¤„ç†æ¡ˆä»¶</li>
                    </ul>
                </div>
                
                <div class="mt-4">
                    <a href="dashboard.html" class="btn btn-primary">
                        <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                    </a>
                    <a href="lawyer-workspace.html" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-briefcase"></i> å¾‹å¸ˆå·¥ä½œå°
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-client.js"></script>
    <!-- ä¸“ä¸šå›¾æ ‡ç³»ç»Ÿ -->
    <script src="/js/icon-system.js"></script>
    <script src="/js/professional-icon-library.js"></script>
    <script src="/js/icon-upgrade-system.js"></script>
    <script>
        let currentStep = 1;
        let extractedData = null;
        let uploadedFile = null;

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });

        function initializeEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            const licenseFile = document.getElementById('licenseFile');
            const uploadArea = document.getElementById('uploadArea');
            
            licenseFile.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            // AIè¯†åˆ«æŒ‰é’®
            document.getElementById('analyzeBtn').addEventListener('click', performAIAnalysis);
            
            // ç¡®è®¤è¯†åˆ«ç»“æœæŒ‰é’®
            document.getElementById('confirmExtractionBtn').addEventListener('click', function() {
                goToStep(3);
            });
            
            // æäº¤è®¤è¯æŒ‰é’®
            document.getElementById('submitCertificationBtn').addEventListener('click', submitCertification);
            
            // è¡¨å•å­—æ®µå˜åŒ–ç›‘å¬
            const formFields = ['lawyerName', 'licenseNumber', 'licenseAuthority', 'issueDate', 'lawFirm'];
            formFields.forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('input', updateFieldStatus);
            });
            
            // å‘è¯æ—¥æœŸå˜åŒ–æ—¶è®¡ç®—æ‰§ä¸šå¹´é™
            document.getElementById('issueDate').addEventListener('change', calculateYearsOfPractice);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }
            
            uploadedFile = file;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            document.getElementById('licenseFile').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            uploadedFile = null;
        }

        async function performAIAnalysis() {
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ å¾‹å¸ˆè¯å›¾ç‰‡');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;
            
            try {
                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('license_image', uploadedFile);
                
                // è°ƒç”¨AIè¯†åˆ«API
                const response = await fetch('/api/v1/lawyer-verification/extract-license-info', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    extractedData = result.data;
                    displayExtractionResult(result.data);
                    goToStep(2);
                } else {
                    alert('AIè¯†åˆ«å¤±è´¥ï¼š' + result.message);
                }
                
            } catch (error) {
                console.error('AIè¯†åˆ«é”™è¯¯:', error);
                alert('AIè¯†åˆ«è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function displayExtractionResult(data) {
            const extractionResult = data.extraction_result;
            const extracted = extractionResult.extracted_info;
            const validation = extractionResult.validation_result;
            const confidence = extractionResult.confidence_score;
            
            let html = `
                <div class="row">
                    <div class="col-md-8">
                        <h6><i class="fas fa-robot"></i> AIè¯†åˆ«ä¿¡æ¯</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>å§“å:</strong> ${extracted.name || 'æœªè¯†åˆ«'}</p>
                                <p><strong>æ€§åˆ«:</strong> ${extracted.gender || 'æœªè¯†åˆ«'}</p>
                                <p><strong>æ‰§ä¸šè¯å·:</strong> ${extracted.license_number || 'æœªè¯†åˆ«'}</p>
                                <p><strong>èº«ä»½è¯å·:</strong> ${extracted.id_card || 'æœªè¯†åˆ«'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>å‘è¯æœºå…³:</strong> ${extracted.authority || 'æœªè¯†åˆ«'}</p>
                                <p><strong>å‘è¯æ—¥æœŸ:</strong> ${extracted.issue_date || 'æœªè¯†åˆ«'}</p>
                                <p><strong>å¾‹å¸ˆäº‹åŠ¡æ‰€:</strong> ${extracted.law_firm || 'æœªè¯†åˆ«'}</p>
                                <p><strong>æ‰§ä¸šå¹´é™:</strong> ${extracted.years_of_practice || 0} å¹´</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-chart-line"></i> è¯†åˆ«è´¨é‡</h6>
                        <p><strong>ç½®ä¿¡åº¦:</strong> 
                            <span class="confidence-badge ${getConfidenceClass(confidence)}">${getConfidenceText(confidence)}</span>
                            <span class="ms-2">${confidence} åˆ†</span>
                        </p>
                        <p><strong>æœ‰æ•ˆå­—æ®µ:</strong> ${validation.valid_fields.length} ä¸ª</p>
                        <p><strong>æ— æ•ˆå­—æ®µ:</strong> ${validation.invalid_fields.length} ä¸ª</p>
                        ${validation.warnings.length > 0 ? `<p><strong>è­¦å‘Š:</strong><br><small class="text-warning">${validation.warnings.join('<br>')}</small></p>` : ''}
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6><i class="fas fa-lightbulb"></i> å»ºè®®</h6>
                    <ul class="mb-0">
                        ${data.suggestions.next_steps.map(step => `<li>${step}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            document.getElementById('extractionResult').innerHTML = html;
            
            // å¡«å……è¡¨å•æ•°æ®
            fillFormWithExtractedData(extracted);
        }

        function fillFormWithExtractedData(extracted) {
            // å¡«å……åŸºæœ¬ä¿¡æ¯
            if (extracted.name) {
                document.getElementById('lawyerName').value = extracted.name;
                updateFieldStatus('lawyerName', 'extracted');
                
                // è‡ªåŠ¨å¡«å……çœŸå®å§“åï¼ˆå¦‚æœä¸ºç©ºï¼‰
                if (!document.getElementById('fullName').value) {
                    document.getElementById('fullName').value = extracted.name;
                    updateFieldStatus('fullName', 'extracted');
                }
            }
            
            if (extracted.gender) {
                document.getElementById('gender').value = extracted.gender;
                updateFieldStatus('gender', 'extracted');
            }
            
            if (extracted.license_number) {
                document.getElementById('licenseNumber').value = extracted.license_number;
                updateFieldStatus('licenseNumber', 'extracted');
            }
            
            if (extracted.id_card) {
                document.getElementById('idCardNumber').value = extracted.id_card;
                updateFieldStatus('idCardNumber', 'extracted');
            }
            
            if (extracted.authority) {
                document.getElementById('licenseAuthority').value = extracted.authority;
                updateFieldStatus('licenseAuthority', 'extracted');
            }
            
            if (extracted.issue_date) {
                document.getElementById('issueDate').value = extracted.issue_date;
                updateFieldStatus('issueDate', 'extracted');
                calculateYearsOfPractice();
            }
            
            if (extracted.law_firm) {
                document.getElementById('lawFirm').value = extracted.law_firm;
                updateFieldStatus('lawFirm', 'extracted');
            }
            
            // æ˜¾ç¤ºç½®ä¿¡åº¦
            const confidence = extractedData.extraction_result.confidence_score;
            document.getElementById('confidenceBadge').className = `confidence-badge ${getConfidenceClass(confidence)}`;
            document.getElementById('confidenceBadge').textContent = getConfidenceText(confidence);
            document.getElementById('confidenceScore').textContent = `${confidence} åˆ†`;
        }

        function getConfidenceClass(score) {
            if (score >= 80) return 'confidence-high';
            if (score >= 60) return 'confidence-medium';
            return 'confidence-low';
        }

        function getConfidenceText(score) {
            if (score >= 80) return 'é«˜';
            if (score >= 60) return 'ä¸­';
            return 'ä½';
        }

        function updateFieldStatus(fieldId, status = 'manual') {
            const statusElement = document.getElementById(fieldId.replace(/([A-Z])/g, '$1').toLowerCase() + 'Status');
            if (statusElement) {
                if (status === 'extracted') {
                    statusElement.innerHTML = '<i class="fas fa-robot field-extracted"></i> AIè¯†åˆ«';
                    statusElement.className = 'field-status field-extracted';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-user field-valid"></i> æ‰‹åŠ¨è¾“å…¥';
                    statusElement.className = 'field-status field-valid';
                }
            }
        }

        function calculateYearsOfPractice() {
            const issueDate = document.getElementById('issueDate').value;
            if (issueDate) {
                const issue = new Date(issueDate);
                const now = new Date();
                const years = Math.floor((now - issue) / (365.25 * 24 * 60 * 60 * 1000));
                document.getElementById('yearsOfPractice').value = Math.max(0, years);
            }
        }

        async function submitCertification() {
            // éªŒè¯å¿…å¡«å­—æ®µ
            const requiredFields = ['lawyerName', 'licenseNumber', 'licenseAuthority', 'issueDate', 'lawFirm'];
            let isValid = true;
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            }
            
            if (!isValid) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            // è·å–ç”¨æˆ·ID
            let userId = null;
            try {
                // ä¼˜å…ˆä»URLå‚æ•°è·å–ï¼ˆä»å¾‹å¸ˆå·¥ä½œå°è·³è½¬è¿‡æ¥ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                userId = urlParams.get('userId');
                const lawyerId = urlParams.get('lawyerId');
                const fromWorkspace = urlParams.get('from') === 'workspace';
                
                // å¦‚æœURLå‚æ•°æ²¡æœ‰ï¼Œä»æœ¬åœ°å­˜å‚¨è·å–
                if (!userId) {
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    userId = userInfo.id || userInfo.user_id;
                }
                
                // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œä½†æ˜¯æœ‰lawyerIdï¼Œè¯´æ˜æ˜¯æ¼”ç¤ºæ¨¡å¼
                if (!userId && lawyerId) {
                    // ä¸ºæ¼”ç¤ºæ¨¡å¼ç”Ÿæˆç”¨æˆ·ID
                    userId = `lawyer-${lawyerId}-demo`;
                    console.log('æ¼”ç¤ºæ¨¡å¼ï¼Œç”Ÿæˆä¸´æ—¶ç”¨æˆ·ID:', userId);
                    
                    // ä¿å­˜æ¼”ç¤ºç”¨æˆ·ä¿¡æ¯
                    const demoUserInfo = {
                        id: userId,
                        user_id: userId,
                        name: `å¾‹å¸ˆ${lawyerId}`,
                        lawyer_name: `å¾‹å¸ˆ${lawyerId}`,
                        role: 'lawyer',
                        lawyer_id: lawyerId,
                        is_demo: true
                    };
                    localStorage.setItem('userInfo', JSON.stringify(demoUserInfo));
                }
                
                if (!userId) {
                    // æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    if (fromWorkspace) {
                        alert('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°ä»å¾‹å¸ˆå·¥ä½œå°è¿›å…¥è®¤è¯é¡µé¢');
                    } else {
                        alert('è¯·å…ˆç™»å½•åå†è¿›è¡Œå¾‹å¸ˆè®¤è¯');
                    }
                    // å¦‚æœæ˜¯ä»å·¥ä½œå°æ¥çš„ï¼Œå…³é—­å½“å‰é¡µé¢
                    if (fromWorkspace) {
                        window.close();
                    }
                    return;
                }
                
                console.log('è·å–åˆ°ç”¨æˆ·ID:', userId);
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                return;
            }
            
            // æ”¶é›†æ‰§ä¸šé¢†åŸŸ
            const practiceAreas = [];
            for (let i = 1; i <= 9; i++) {
                const checkbox = document.getElementById(`area${i}`);
                if (checkbox.checked) {
                    practiceAreas.push(checkbox.value);
                }
            }
            
            // æ„å»ºæäº¤æ•°æ®
            const certificationData = {
                user_id: userId,
                extracted_info: {
                    name: document.getElementById('lawyerName').value,
                    gender: document.getElementById('gender').value,
                    license_number: document.getElementById('licenseNumber').value,
                    id_card: document.getElementById('idCardNumber').value,
                    authority: document.getElementById('licenseAuthority').value,
                    issue_date: document.getElementById('issueDate').value,
                    law_firm: document.getElementById('lawFirm').value
                },
                additional_info: {
                    practice_areas: practiceAreas,
                    confidence_score: extractedData ? extractedData.extraction_result.confidence_score : 0,
                    years_of_practice: parseInt(document.getElementById('yearsOfPractice').value) || 0
                }
            };
            
            try {
                const response = await fetch('/api/v1/lawyer-verification/submit-certification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(certificationData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    goToStep(4);
                } else {
                    alert('æäº¤è®¤è¯ç”³è¯·å¤±è´¥ï¼š' + result.message);
                }
                
            } catch (error) {
                console.error('æäº¤è®¤è¯ç”³è¯·é”™è¯¯:', error);
                alert('æäº¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        function goToStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`section${i}`).classList.remove('active');
                document.getElementById(`step${i}`).classList.remove('active', 'completed');
            }
            
            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            document.getElementById(`section${step}`).classList.add('active');
            document.getElementById(`step${step}`).classList.add('active');
            
            // æ ‡è®°å·²å®Œæˆçš„æ­¥éª¤
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }
            
            currentStep = step;
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–å¹¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            const fromWorkspace = urlParams.get('from') === 'workspace';
            
            if (userId) {
                // å¦‚æœæ˜¯ä»å·¥ä½œå°æ¥çš„ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (fromWorkspace) {
                    const headerElement = document.querySelector('.page-header');
                    if (headerElement) {
                        const userInfoDiv = document.createElement('div');
                        userInfoDiv.style.cssText = `
                            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(124, 58, 237, 0.05) 100%);
                            border: 1px solid rgba(102, 126, 234, 0.3);
                            border-radius: 12px;
                            padding: 16px;
                            margin-bottom: 24px;
                            color: var(--text-primary);
                            font-size: 14px;
                        `;
                        userInfoDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 16px;">ğŸ‘¤</span>
                                <strong>å½“å‰è®¤è¯è´¦æˆ·</strong>
                            </div>
                            <div style="color: var(--text-secondary);">
                                ç”¨æˆ·ID: ${userId}
                                <br>æ¥æº: å¾‹å¸ˆå·¥ä½œå°
                                <br>è¯·æŒ‰ç…§æ­¥éª¤å®Œæˆå¾‹å¸ˆèµ„æ ¼è®¤è¯
                            </div>
                        `;
                        headerElement.appendChild(userInfoDiv);
                    }
                }
                
                console.log('å¾‹å¸ˆè®¤è¯é¡µé¢åˆå§‹åŒ–ï¼Œç”¨æˆ·ID:', userId);
            } else {
                console.warn('æœªè·å–åˆ°ç”¨æˆ·IDï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç™»å½•');
            }
        });
    </script>
</body>
</html> 