<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#2563eb">
    <title>移动端性能测试 - Lawsker</title>
    
    <!-- 响应式设计系统 -->
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/responsive-enhanced.css">
    
    <style>
        .performance-test-container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: var(--bg-primary);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .test-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            margin-bottom: 16px;
            color: var(--color-primary);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }
        
        .metric-card {
            background: var(--gray-50);
            padding: 16px;
            border-radius: var(--radius-lg);
            text-align: center;
        }
        
        .metric-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--color-primary);
            display: block;
        }
        
        .metric-label {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .test-button {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-lg);
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            margin: 8px;
            min-height: var(--touch-target-min);
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .test-button:active {
            transform: scale(0.98);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: 16px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .test-log {
            background: var(--gray-900);
            color: var(--gray-100);
            padding: 16px;
            border-radius: var(--radius-lg);
            font-family: var(--font-family-mono);
            font-size: var(--text-sm);
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: var(--success-500); }
        .status-warning { background: var(--warning-500); }
        .status-error { background: var(--error-500); }
        
        .touch-test-area {
            background: var(--primary-50);
            border: 2px dashed var(--primary-300);
            border-radius: var(--radius-xl);
            padding: 40px;
            text-align: center;
            margin: 16px 0;
            user-select: none;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .touch-test-area.active {
            background: var(--primary-100);
            border-color: var(--primary-500);
            transform: scale(0.98);
        }
        
        @media (max-width: 768px) {
            .performance-test-container {
                padding: 16px;
            }
            
            .test-section {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .metric-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="performance-test-container">
        <header class="test-section">
            <h1 class="text-3xl font-bold text-center mb-4">📱 移动端性能测试</h1>
            <p class="text-center text-secondary">验证响应式设计的移动端体验评分</p>
        </header>

        <!-- 设备信息 -->
        <section class="test-section">
            <h2 class="test-title">📊 设备信息</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <span class="metric-value" id="screen-size">-</span>
                    <div class="metric-label">屏幕尺寸</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="device-type">-</span>
                    <div class="metric-label">设备类型</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="pixel-ratio">-</span>
                    <div class="metric-label">像素比</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="touch-support">-</span>
                    <div class="metric-label">触摸支持</div>
                </div>
            </div>
        </section>

        <!-- 性能指标 -->
        <section class="test-section">
            <h2 class="test-title">⚡ 性能指标</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <span class="metric-value" id="load-time">-</span>
                    <div class="metric-label">加载时间 (ms)</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="fcp-time">-</span>
                    <div class="metric-label">首屏渲染 (ms)</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="memory-usage">-</span>
                    <div class="metric-label">内存使用 (MB)</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="fps-count">-</span>
                    <div class="metric-label">帧率 (FPS)</div>
                </div>
            </div>
        </section>

        <!-- 触摸响应测试 -->
        <section class="test-section">
            <h2 class="test-title">👆 触摸响应测试</h2>
            <div class="touch-test-area" id="touch-test">
                <div>点击或触摸这里测试响应时间</div>
                <div class="text-sm text-secondary mt-2">平均响应时间: <span id="touch-response-time">0ms</span></div>
            </div>
            <div class="metric-grid">
                <div class="metric-card">
                    <span class="metric-value" id="touch-count">0</span>
                    <div class="metric-label">触摸次数</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="avg-response">0ms</span>
                    <div class="metric-label">平均响应</div>
                </div>
            </div>
        </section>

        <!-- 滚动性能测试 -->
        <section class="test-section">
            <h2 class="test-title">📜 滚动性能测试</h2>
            <button class="test-button" onclick="startScrollTest()">开始滚动测试</button>
            <div class="progress-bar">
                <div class="progress-fill" id="scroll-progress"></div>
            </div>
            <div class="metric-grid">
                <div class="metric-card">
                    <span class="metric-value" id="scroll-fps">-</span>
                    <div class="metric-label">滚动帧率</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="scroll-smoothness">-</span>
                    <div class="metric-label">流畅度评分</div>
                </div>
            </div>
        </section>

        <!-- 网络状态 -->
        <section class="test-section">
            <h2 class="test-title">🌐 网络状态</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <span class="metric-value" id="connection-type">-</span>
                    <div class="metric-label">连接类型</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="effective-type">-</span>
                    <div class="metric-label">有效类型</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="downlink">-</span>
                    <div class="metric-label">下行速度 (Mbps)</div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="rtt">-</span>
                    <div class="metric-label">延迟 (ms)</div>
                </div>
            </div>
        </section>

        <!-- 综合评分 -->
        <section class="test-section">
            <h2 class="test-title">🎯 移动端体验评分</h2>
            <div class="text-center">
                <div class="text-6xl font-bold text-primary mb-4" id="overall-score">-</div>
                <div class="text-lg text-secondary mb-4">/ 5.0</div>
                <button class="test-button" onclick="calculateOverallScore()">计算综合评分</button>
            </div>
            <div class="test-log" id="score-log"></div>
        </section>
    </div>

    <!-- JavaScript -->
    <script src="js/responsive-enhanced.js"></script>
    <!-- 专业图标系统 -->
    <script src="/js/icon-system.js"></script>
    <script src="/js/professional-icon-library.js"></script>
    <script src="/js/icon-upgrade-system.js"></script>
    <script>
        class MobilePerformanceTester {
            constructor() {
                this.touchTimes = [];
                this.scrollFrames = [];
                this.testResults = {};
                this.init();
            }

            init() {
                this.updateDeviceInfo();
                this.setupPerformanceMonitoring();
                this.setupTouchTesting();
                this.updateNetworkInfo();
                
                // 页面加载完成后更新性能指标
                window.addEventListener('load', () => {
                    setTimeout(() => this.updatePerformanceMetrics(), 100);
                });
            }

            updateDeviceInfo() {
                document.getElementById('screen-size').textContent = 
                    `${window.innerWidth}×${window.innerHeight}`;
                
                const deviceType = window.innerWidth < 768 ? '移动端' : 
                                 window.innerWidth < 1024 ? '平板' : '桌面';
                document.getElementById('device-type').textContent = deviceType;
                
                document.getElementById('pixel-ratio').textContent = 
                    window.devicePixelRatio || 1;
                
                document.getElementById('touch-support').textContent = 
                    'ontouchstart' in window ? '是' : '否';
            }

            setupPerformanceMonitoring() {
                // FPS监控
                let frames = 0;
                let lastTime = performance.now();
                
                const countFPS = () => {
                    frames++;
                    const currentTime = performance.now();
                    
                    if (currentTime >= lastTime + 1000) {
                        document.getElementById('fps-count').textContent = frames;
                        frames = 0;
                        lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(countFPS);
                };
                
                requestAnimationFrame(countFPS);
            }

            updatePerformanceMetrics() {
                // 页面加载时间
                const navigation = performance.getEntriesByType('navigation')[0];
                if (navigation) {
                    const loadTime = Math.round(navigation.loadEventEnd - navigation.loadEventStart);
                    document.getElementById('load-time').textContent = loadTime;
                    this.testResults.loadTime = loadTime;
                }

                // 首屏渲染时间
                const observer = new PerformanceObserver((list) => {
                    for (const entry of list.getEntries()) {
                        if (entry.name === 'first-contentful-paint') {
                            const fcpTime = Math.round(entry.startTime);
                            document.getElementById('fcp-time').textContent = fcpTime;
                            this.testResults.fcpTime = fcpTime;
                        }
                    }
                });
                
                try {
                    observer.observe({ entryTypes: ['paint'] });
                } catch (e) {
                    document.getElementById('fcp-time').textContent = '不支持';
                }

                // 内存使用
                if (performance.memory) {
                    const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                    document.getElementById('memory-usage').textContent = memoryMB;
                    this.testResults.memoryUsage = memoryMB;
                } else {
                    document.getElementById('memory-usage').textContent = '不支持';
                }
            }

            setupTouchTesting() {
                const touchArea = document.getElementById('touch-test');
                let touchStartTime = 0;

                const handleStart = (e) => {
                    touchStartTime = performance.now();
                    touchArea.classList.add('active');
                };

                const handleEnd = (e) => {
                    const responseTime = performance.now() - touchStartTime;
                    this.touchTimes.push(responseTime);
                    
                    touchArea.classList.remove('active');
                    
                    // 更新统计
                    document.getElementById('touch-count').textContent = this.touchTimes.length;
                    
                    const avgResponse = this.touchTimes.reduce((a, b) => a + b, 0) / this.touchTimes.length;
                    document.getElementById('avg-response').textContent = Math.round(avgResponse) + 'ms';
                    document.getElementById('touch-response-time').textContent = Math.round(responseTime) + 'ms';
                    
                    this.testResults.avgTouchResponse = avgResponse;
                };

                touchArea.addEventListener('touchstart', handleStart, { passive: true });
                touchArea.addEventListener('touchend', handleEnd, { passive: true });
                touchArea.addEventListener('mousedown', handleStart);
                touchArea.addEventListener('mouseup', handleEnd);
            }

            updateNetworkInfo() {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                
                if (connection) {
                    document.getElementById('connection-type').textContent = 
                        connection.type || '未知';
                    document.getElementById('effective-type').textContent = 
                        connection.effectiveType || '未知';
                    document.getElementById('downlink').textContent = 
                        connection.downlink || '未知';
                    document.getElementById('rtt').textContent = 
                        connection.rtt || '未知';
                        
                    this.testResults.networkType = connection.effectiveType;
                } else {
                    document.getElementById('connection-type').textContent = '不支持';
                    document.getElementById('effective-type').textContent = '不支持';
                    document.getElementById('downlink').textContent = '不支持';
                    document.getElementById('rtt').textContent = '不支持';
                }
            }

            calculateOverallScore() {
                const log = document.getElementById('score-log');
                log.innerHTML = '';
                
                let totalScore = 0;
                let factors = 0;
                
                const addLog = (message) => {
                    log.innerHTML += message + '\n';
                };

                addLog('🔍 开始计算移动端体验评分...\n');

                // 加载性能评分 (25%)
                if (this.testResults.loadTime !== undefined) {
                    let loadScore = 5;
                    if (this.testResults.loadTime > 3000) loadScore = 1;
                    else if (this.testResults.loadTime > 2000) loadScore = 2;
                    else if (this.testResults.loadTime > 1000) loadScore = 3;
                    else if (this.testResults.loadTime > 500) loadScore = 4;
                    
                    totalScore += loadScore * 0.25;
                    factors += 0.25;
                    addLog(`📊 加载性能: ${this.testResults.loadTime}ms → ${loadScore}/5 (权重25%)`);
                }

                // 首屏渲染评分 (20%)
                if (this.testResults.fcpTime !== undefined) {
                    let fcpScore = 5;
                    if (this.testResults.fcpTime > 4000) fcpScore = 1;
                    else if (this.testResults.fcpTime > 2500) fcpScore = 2;
                    else if (this.testResults.fcpTime > 1500) fcpScore = 3;
                    else if (this.testResults.fcpTime > 800) fcpScore = 4;
                    
                    totalScore += fcpScore * 0.20;
                    factors += 0.20;
                    addLog(`🎨 首屏渲染: ${this.testResults.fcpTime}ms → ${fcpScore}/5 (权重20%)`);
                }

                // 触摸响应评分 (25%)
                if (this.testResults.avgTouchResponse !== undefined) {
                    let touchScore = 5;
                    if (this.testResults.avgTouchResponse > 200) touchScore = 1;
                    else if (this.testResults.avgTouchResponse > 150) touchScore = 2;
                    else if (this.testResults.avgTouchResponse > 100) touchScore = 3;
                    else if (this.testResults.avgTouchResponse > 50) touchScore = 4;
                    
                    totalScore += touchScore * 0.25;
                    factors += 0.25;
                    addLog(`👆 触摸响应: ${Math.round(this.testResults.avgTouchResponse)}ms → ${touchScore}/5 (权重25%)`);
                }

                // 内存使用评分 (15%)
                if (this.testResults.memoryUsage !== undefined) {
                    let memoryScore = 5;
                    if (this.testResults.memoryUsage > 100) memoryScore = 1;
                    else if (this.testResults.memoryUsage > 75) memoryScore = 2;
                    else if (this.testResults.memoryUsage > 50) memoryScore = 3;
                    else if (this.testResults.memoryUsage > 25) memoryScore = 4;
                    
                    totalScore += memoryScore * 0.15;
                    factors += 0.15;
                    addLog(`💾 内存使用: ${this.testResults.memoryUsage}MB → ${memoryScore}/5 (权重15%)`);
                }

                // 网络适配评分 (15%)
                if (this.testResults.networkType) {
                    let networkScore = 5;
                    if (this.testResults.networkType === 'slow-2g') networkScore = 2;
                    else if (this.testResults.networkType === '2g') networkScore = 3;
                    else if (this.testResults.networkType === '3g') networkScore = 4;
                    
                    totalScore += networkScore * 0.15;
                    factors += 0.15;
                    addLog(`🌐 网络适配: ${this.testResults.networkType} → ${networkScore}/5 (权重15%)`);
                }

                const finalScore = factors > 0 ? totalScore / factors * 5 : 0;
                
                addLog(`\n🎯 综合评分计算:`);
                addLog(`   总分: ${totalScore.toFixed(2)}`);
                addLog(`   权重: ${factors.toFixed(2)}`);
                addLog(`   最终评分: ${finalScore.toFixed(2)}/5`);
                
                if (finalScore >= 4.5) {
                    addLog(`\n✅ 优秀！移动端体验评分达到目标 (≥4.5/5)`);
                } else if (finalScore >= 4.0) {
                    addLog(`\n⚠️  良好，但仍有优化空间`);
                } else {
                    addLog(`\n❌ 需要优化移动端体验`);
                }

                document.getElementById('overall-score').textContent = finalScore.toFixed(2);
                
                // 滚动到底部
                log.scrollTop = log.scrollHeight;
            }
        }

        // 滚动测试函数
        function startScrollTest() {
            const progressBar = document.getElementById('scroll-progress');
            const scrollFpsElement = document.getElementById('scroll-fps');
            const smoothnessElement = document.getElementById('scroll-smoothness');
            
            let frames = 0;
            let startTime = performance.now();
            let lastFrameTime = startTime;
            let frameDeltas = [];
            
            const testDuration = 3000; // 3秒测试
            
            const animateScroll = () => {
                const currentTime = performance.now();
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / testDuration, 1) * 100;
                
                progressBar.style.width = progress + '%';
                
                // 计算帧率
                frames++;
                const frameDelta = currentTime - lastFrameTime;
                frameDeltas.push(frameDelta);
                lastFrameTime = currentTime;
                
                if (elapsed < testDuration) {
                    requestAnimationFrame(animateScroll);
                } else {
                    // 测试完成，计算结果
                    const avgFps = Math.round(frames / (testDuration / 1000));
                    const avgFrameDelta = frameDeltas.reduce((a, b) => a + b, 0) / frameDeltas.length;
                    const smoothness = Math.max(0, Math.min(100, 100 - (avgFrameDelta - 16.67) * 2));
                    
                    scrollFpsElement.textContent = avgFps;
                    smoothnessElement.textContent = Math.round(smoothness) + '%';
                }
            };
            
            requestAnimationFrame(animateScroll);
        }

        // 初始化测试器
        const tester = new MobilePerformanceTester();
        
        // 窗口大小变化时更新设备信息
        window.addEventListener('resize', () => {
            tester.updateDeviceInfo();
        });
    </script>
</body>
</html>