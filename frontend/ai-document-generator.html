<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÊñá‰π¶ÁîüÊàêÂô® - Lawsker (ÂæãÊÄùÂÆ¢)</title>
    <link rel="stylesheet" href="/css/lawsker-glass.css">
    <style>
        .generator-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .input-panel, .output-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            backdrop-filter: blur(10px);
            height: fit-content;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .task-info {
            background: rgba(248, 249, 250, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .task-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .task-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .ai-engine-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .engine-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .engine-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .engine-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .engine-option .engine-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .engine-option .engine-desc {
            font-size: 12px;
            color: #666;
        }
        
        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .document-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            font-family: 'SimSun', serif;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }
        
        .document-output.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }
        
        .document-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .quality-score {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        
        .score-details {
            font-size: 12px;
            color: #666;
        }
        
        .generating {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .review-panel {
            background: rgba(255, 243, 224, 0.8);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .version-history {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .version-item:last-child {
            border-bottom: none;
        }
        
        .version-info {
            flex: 1;
        }
        
        .version-label {
            font-weight: bold;
            color: #333;
        }
        
        .version-meta {
            font-size: 12px;
            color: #666;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        @media (max-width: 768px) {
            .generator-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AIÊñá‰π¶ÁîüÊàêÂô®</h1>
            <p>Êô∫ËÉΩÁîüÊàê‰∏ì‰∏öÊ≥ïÂæãÊñá‰π¶ÔºåÂæãÂ∏àÂÆ°Ê†∏Á°ÆËÆ§</p>
        </div>
        
        <div class="generator-container">
            <!-- ËæìÂÖ•Èù¢Êùø -->
            <div class="input-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        üìù Êñá‰π¶ÁîüÊàêËÆæÁΩÆ
                    </div>
                </div>
                
                <!-- ‰ªªÂä°‰ø°ÊÅØ -->
                <div class="task-info" id="taskInfo">
                    <h3>üìã ÂΩìÂâç‰ªªÂä°</h3>
                    <div class="task-meta" id="taskMeta">
                        <div>‰ªªÂä°Á±ªÂûã: <strong id="taskType">-</strong></div>
                        <div>È¢ÑÁÆó: <strong id="taskBudget">-</strong></div>
                        <div>Á¥ßÊÄ•Á®ãÂ∫¶: <strong id="taskUrgency">-</strong></div>
                        <div>ÂàõÂª∫Êó∂Èó¥: <strong id="taskCreated">-</strong></div>
                    </div>
                </div>
                
                <!-- AIÂºïÊìéÈÄâÊã© -->
                <div class="form-group">
                    <label>ÈÄâÊã©AIÂºïÊìé</label>
                    <div class="ai-engine-selector">
                        <div class="engine-option selected" data-engine="openai">
                            <div class="engine-name">ChatGPT-4</div>
                            <div class="engine-desc">ÈÄªËæë‰∏•ÂØÜÔºå‰∏ì‰∏öÂáÜÁ°Æ</div>
                        </div>
                        <div class="engine-option" data-engine="deepseek">
                            <div class="engine-name">Deepseek</div>
                            <div class="engine-desc">‰∏≠Êñá‰ºòÂåñÔºåÊú¨ÂúüÂåñÂº∫</div>
                        </div>
                    </div>
                </div>
                
                <!-- Êñá‰π¶Á±ªÂûã -->
                <div class="form-group">
                    <label for="documentType">Êñá‰π¶Á±ªÂûã</label>
                    <select id="documentType">
                        <option value="collection_letter">ÂÄ∫Âä°ÂÇ¨Êî∂ÂáΩ</option>
                        <option value="demand_letter">ÂæãÂ∏àÂáΩ</option>
                        <option value="warning_letter">Ë≠¶ÂëäÂáΩ</option>
                        <option value="cease_desist">ÂÅúÊ≠¢‰æµÊùÉÂáΩ</option>
                        <option value="breach_notice">ËøùÁ∫¶ÈÄöÁü•‰π¶</option>
                    </select>
                </div>
                
                <!-- ËØ≠Ë∞ÉÈ£éÊ†º -->
                <div class="form-group">
                    <label for="documentTone">ËØ≠Ë∞ÉÈ£éÊ†º</label>
                    <select id="documentTone">
                        <option value="friendly_reminder">ÂèãÂ•ΩÊèêÈÜí</option>
                        <option value="formal_notice">Ê≠£ÂºèÈÄöÁü•</option>
                        <option value="stern_warning">‰∏•ÂéâË≠¶Âëä</option>
                        <option value="legal_threat">Ê≥ïÂæãÂ®ÅÊÖë</option>
                    </select>
                </div>
                
                <!-- Âü∫Êú¨‰ø°ÊÅØ -->
                <div class="form-group">
                    <label for="senderName">ÂèëÂáΩÊñπ(ÂæãÂ∏à/ÂæãÊâÄ)</label>
                    <input type="text" id="senderName" placeholder="ËØ∑ËæìÂÖ•ÂæãÂ∏àÊàñÂæãÊâÄÂêçÁß∞">
                </div>
                
                <div class="form-group">
                    <label for="recipientName">Êî∂ÂáΩÊñπ</label>
                    <input type="text" id="recipientName" placeholder="ËØ∑ËæìÂÖ•Êî∂ÂáΩÊñπÂßìÂêçÊàñÂÖ¨Âè∏ÂêçÁß∞">
                </div>
                
                <div class="form-group">
                    <label for="caseAmount">Ê∂âÂèäÈáëÈ¢ù(ÂÖÉ)</label>
                    <input type="number" id="caseAmount" placeholder="Â¶ÇÊúâÈáëÈ¢ù‰∫âËÆÆËØ∑Â°´ÂÜô">
                </div>
                
                <div class="form-group">
                    <label for="caseDescription">Ê°àÊÉÖÊèèËø∞</label>
                    <textarea id="caseDescription" placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞Ê°à‰ª∂ËÉåÊôØ„ÄÅ‰∫âËÆÆÁÑ¶ÁÇπ„ÄÅ‰∫ãÂÆûÁªèËøáÁ≠â"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="legalBasis">Ê≥ïÂæã‰æùÊçÆ</label>
                    <textarea id="legalBasis" placeholder="Áõ∏ÂÖ≥Ê≥ïÂæãÊù°ÊñáÔºåÂ¶Ç‰∏çÂ°´ÂÜôAIÂ∞ÜËá™Âä®ÈÄâÊã©"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="demands">ÂÖ∑‰ΩìË¶ÅÊ±Ç</label>
                    <textarea id="demands" placeholder="Â∏åÊúõÂØπÊñπÈááÂèñÁöÑÂÖ∑‰ΩìË°åÂä®ÊàñÂ±•Ë°åÁöÑ‰πâÂä°"></textarea>
                </div>
                
                <button class="generate-btn" onclick="generateDocument()" id="generateBtn">
                    üöÄ ÁîüÊàêÊñá‰π¶
                </button>
                
                <!-- Ê®°ÊùøÂ∫ìÂø´Êç∑ÊåâÈíÆ -->
                <div class="form-group">
                    <label>Âø´Êç∑Ê®°Êùø</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="loadTemplate('debt_collection')">ÂÄ∫Âä°ÂÇ¨Êî∂</button>
                        <button class="btn btn-secondary" onclick="loadTemplate('contract_breach')">ÂêàÂêåËøùÁ∫¶</button>
                        <button class="btn btn-secondary" onclick="loadTemplate('payment_reminder')">‰ªòÊ¨æÊèêÈÜí</button>
                        <button class="btn btn-secondary" onclick="loadTemplate('infringement')">‰æµÊùÉÈÄöÁü•</button>
                    </div>
                </div>
            </div>
            
            <!-- ËæìÂá∫Èù¢Êùø -->
            <div class="output-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        üìÑ ÁîüÊàêÁªìÊûú
                    </div>
                    <div id="documentStatus" style="font-size: 12px; color: #666;"></div>
                </div>
                
                <!-- Ë¥®ÈáèËØÑÂàÜ -->
                <div class="quality-score" id="qualityScore" style="display: none;">
                    <div class="score-header">
                        <span>üìä Êñá‰π¶Ë¥®ÈáèËØÑÂàÜ</span>
                        <span class="score-value" id="scoreValue">-</span>
                    </div>
                    <div class="score-details" id="scoreDetails">AIÊ≠£Âú®ËØÑ‰º∞Êñá‰π¶Ë¥®Èáè...</div>
                </div>
                
                <!-- Êñá‰π¶ÂÜÖÂÆπ -->
                <div class="document-output empty" id="documentOutput">
                    ÁÇπÂáª"ÁîüÊàêÊñá‰π¶"ÂºÄÂßãAIÂàõ‰Ωú...
                </div>
                
                <!-- Êñá‰π¶Êìç‰Ωú -->
                <div class="document-actions" id="documentActions" style="display: none;">
                    <button class="btn btn-primary" onclick="regenerateDocument()">
                        üîÑ ÈáçÊñ∞ÁîüÊàê
                    </button>
                    <button class="btn btn-warning" onclick="editDocument()">
                        ‚úèÔ∏è ÊâãÂä®ÁºñËæë
                    </button>
                    <button class="btn btn-secondary" onclick="previewDocument()">
                        üëÅÔ∏è È¢ÑËßà
                    </button>
                    <button class="btn btn-success" onclick="approveDocument()">
                        ‚úÖ ÂÆ°Ê†∏ÈÄöËøá
                    </button>
                </div>
                
                <!-- ÂæãÂ∏àÂÆ°Ê†∏Èù¢Êùø -->
                <div class="review-panel" id="reviewPanel" style="display: none;">
                    <h4>‚öñÔ∏è ÂæãÂ∏àÂÆ°Ê†∏</h4>
                    <p>ËØ∑‰ªîÁªÜÂÆ°Ê†∏AIÁîüÊàêÁöÑÊñá‰π¶ÂÜÖÂÆπÔºåÁ°Æ‰øùÊ≥ïÊù°ÂºïÁî®ÂáÜÁ°Æ„ÄÅÈÄªËæëÊ∏ÖÊô∞„ÄÅÊ†ºÂºèËßÑËåÉ„ÄÇ</p>
                    <div class="form-group">
                        <label for="reviewNotes">ÂÆ°Ê†∏ÊÑèËßÅ</label>
                        <textarea id="reviewNotes" placeholder="ËØ∑Â°´ÂÜôÂÆ°Ê†∏ÊÑèËßÅÂíå‰øÆÊîπÂª∫ËÆÆ"></textarea>
                    </div>
                    <div class="review-actions">
                        <button class="btn btn-success" onclick="approveDocument()">
                            ‚úÖ ÈÄöËøáÂÆ°Ê†∏
                        </button>
                        <button class="btn btn-warning" onclick="requestModification()">
                            üîÑ Ë¶ÅÊ±Ç‰øÆÊîπ
                        </button>
                        <button class="btn btn-secondary" onclick="rejectDocument()">
                            ‚ùå ÊãíÁªùÊñá‰π¶
                        </button>
                    </div>
                </div>
                
                <!-- ÁâàÊú¨ÂéÜÂè≤ -->
                <div class="version-history" id="versionHistory" style="display: none;">
                    <h4>üìã ÁâàÊú¨ÂéÜÂè≤</h4>
                    <div id="versionList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÈÄöÁü• -->
    <div id="notification" class="notification"></div>

    <script>
        let currentTask = null;
        let currentDocument = null;
        let selectedEngine = 'openai';
        let documentVersions = [];
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // ‰ªéURLÂèÇÊï∞Ëé∑Âèñ‰ªªÂä°ID
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('task_id');
            
            if (taskId) {
                loadTaskInfo(taskId);
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰ªªÂä°IDÔºåÊòæÁ§∫Á§∫‰æã‰ªªÂä°
                loadSampleTask();
            }
            
            // ÁªëÂÆöAIÂºïÊìéÈÄâÊã©
            bindEngineSelector();
        });
        
        // ÁªëÂÆöAIÂºïÊìéÈÄâÊã©Âô®
        function bindEngineSelector() {
            document.querySelectorAll('.engine-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.engine-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedEngine = this.dataset.engine;
                });
            });
        }
        
        // Âä†ËΩΩ‰ªªÂä°‰ø°ÊÅØ
        async function loadTaskInfo(taskId) {
            try {
                const response = await fetch(`/api/v1/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    currentTask = await response.json();
                    displayTaskInfo();
                    prefillFormFromTask();
                } else {
                    throw new Error('Âä†ËΩΩ‰ªªÂä°‰ø°ÊÅØÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•:', error);
                showNotification('Âä†ËΩΩ‰ªªÂä°‰ø°ÊÅØÂ§±Ë¥•', 'error');
                loadSampleTask();
            }
        }
        
        // Âä†ËΩΩÁ§∫‰æã‰ªªÂä°
        function loadSampleTask() {
            currentTask = {
                task_type: 'collection_letter',
                title: 'ÂÄ∫Âä°ÂÇ¨Êî∂Ê°à‰ª∂',
                budget: 1000,
                urgency: 'normal',
                created_at: new Date().toISOString(),
                description: 'ÊüêÂÖ¨Âè∏ÊãñÊ¨†Ë¥ßÊ¨æ30‰∏áÂÖÉÔºåÈúÄË¶ÅÂèëÂáΩÂÇ¨Êî∂',
                target_info: {
                    name: 'ÊüêÊüêÂÖ¨Âè∏',
                    amount: 300000
                }
            };
            displayTaskInfo();
            prefillFormFromTask();
        }
        
        // ÊòæÁ§∫‰ªªÂä°‰ø°ÊÅØ
        function displayTaskInfo() {
            const taskTypeMap = {
                'collection_letter': 'ÂÄ∫Âä°ÂÇ¨Êî∂',
                'demand_letter': 'ÂæãÂ∏àÂáΩÊúçÂä°',
                'contract_review': 'ÂêàÂêåÂÆ°Ê†∏',
                'legal_consultation': 'Ê≥ïÂæãÂí®ËØ¢'
            };
            
            const urgencyMap = {
                'normal': 'ÊôÆÈÄö',
                'urgent': 'Á¥ßÊÄ•',
                'emergency': 'ÁâπÊÄ•'
            };
            
            document.getElementById('taskType').textContent = taskTypeMap[currentTask.task_type] || currentTask.task_type;
            document.getElementById('taskBudget').textContent = '¬•' + currentTask.budget;
            document.getElementById('taskUrgency').textContent = urgencyMap[currentTask.urgency] || currentTask.urgency;
            document.getElementById('taskCreated').textContent = formatDate(currentTask.created_at);
        }
        
        // ‰ªé‰ªªÂä°‰ø°ÊÅØÈ¢ÑÂ°´Ë°®Âçï
        function prefillFormFromTask() {
            if (currentTask.target_info) {
                document.getElementById('recipientName').value = currentTask.target_info.name || '';
                document.getElementById('caseAmount').value = currentTask.target_info.amount || '';
            }
            
            document.getElementById('caseDescription').value = currentTask.description || '';
            
            // Ê†πÊçÆ‰ªªÂä°Á±ªÂûãËÆæÁΩÆÊñá‰π¶Á±ªÂûã
            const typeMapping = {
                'collection_letter': 'collection_letter',
                'demand_letter': 'demand_letter'
            };
            
            const documentType = typeMapping[currentTask.task_type];
            if (documentType) {
                document.getElementById('documentType').value = documentType;
            }
        }
        
        // ÁîüÊàêÊñá‰π¶
        async function generateDocument() {
            const formData = collectFormData();
            
            if (!validateFormData(formData)) {
                showNotification('ËØ∑Â°´ÂÜôÂøÖË¶Å‰ø°ÊÅØ', 'error');
                return;
            }
            
            // ÊòæÁ§∫ÁîüÊàê‰∏≠Áä∂ÊÄÅ
            showGenerating();
            
            try {
                const response = await fetch('/api/v1/ai/generate-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        task_id: currentTask.id,
                        ai_engine: selectedEngine,
                        document_type: formData.documentType,
                        tone: formData.documentTone,
                        sender_name: formData.senderName,
                        recipient_name: formData.recipientName,
                        case_amount: formData.caseAmount,
                        case_description: formData.caseDescription,
                        legal_basis: formData.legalBasis,
                        demands: formData.demands
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentDocument = result.data;
                    displayDocument();
                    addDocumentVersion();
                    evaluateQuality();
                    showNotification('Êñá‰π¶ÁîüÊàêÊàêÂäü', 'success');
                } else {
                    throw new Error(result.message || 'ÁîüÊàêÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÁîüÊàêÊñá‰π¶Â§±Ë¥•:', error);
                showNotification('ÁîüÊàêÂ§±Ë¥•Ôºö' + error.message, 'error');
                hideGenerating();
            }
        }
        
        // Êî∂ÈõÜË°®ÂçïÊï∞ÊçÆ
        function collectFormData() {
            return {
                documentType: document.getElementById('documentType').value,
                documentTone: document.getElementById('documentTone').value,
                senderName: document.getElementById('senderName').value,
                recipientName: document.getElementById('recipientName').value,
                caseAmount: document.getElementById('caseAmount').value,
                caseDescription: document.getElementById('caseDescription').value,
                legalBasis: document.getElementById('legalBasis').value,
                demands: document.getElementById('demands').value
            };
        }
        
        // È™åËØÅË°®ÂçïÊï∞ÊçÆ
        function validateFormData(data) {
            return data.recipientName && data.caseDescription && data.demands;
        }
        
        // ÊòæÁ§∫ÁîüÊàê‰∏≠Áä∂ÊÄÅ
        function showGenerating() {
            const output = document.getElementById('documentOutput');
            output.className = 'document-output';
            output.innerHTML = `
                <div class="generating">
                    <div class="spinner"></div>
                    <p>AIÊ≠£Âú®ÁîüÊàêÊñá‰π¶ÔºåËØ∑Á®çÂÄô...</p>
                    <p style="font-size: 12px; color: #999;">
                        ‰ΩøÁî®${selectedEngine === 'openai' ? 'ChatGPT-4' : 'Deepseek'}ÂºïÊìé
                    </p>
                </div>
            `;
            
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('documentActions').style.display = 'none';
        }
        
        // ÈöêËóèÁîüÊàê‰∏≠Áä∂ÊÄÅ
        function hideGenerating() {
            document.getElementById('generateBtn').disabled = false;
        }
        
        // ÊòæÁ§∫Êñá‰π¶ÂÜÖÂÆπ
        function displayDocument() {
            const output = document.getElementById('documentOutput');
            output.className = 'document-output';
            output.textContent = currentDocument.content || 'ÁîüÊàêÁöÑÊñá‰π¶ÂÜÖÂÆπÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå...';
            
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('documentActions').style.display = 'flex';
            document.getElementById('reviewPanel').style.display = 'block';
            document.getElementById('documentStatus').textContent = `AIÂºïÊìéÔºö${selectedEngine === 'openai' ? 'ChatGPT-4' : 'Deepseek'} | ÁîüÊàêÊó∂Èó¥Ôºö${formatTime(new Date())}`;
        }
        
        // Ê∑ªÂä†Êñá‰π¶ÁâàÊú¨
        function addDocumentVersion() {
            const version = {
                id: documentVersions.length + 1,
                content: currentDocument.content,
                engine: selectedEngine,
                created_at: new Date(),
                status: 'generated'
            };
            
            documentVersions.push(version);
            updateVersionHistory();
        }
        
        // Êõ¥Êñ∞ÁâàÊú¨ÂéÜÂè≤
        function updateVersionHistory() {
            const container = document.getElementById('versionList');
            const historyPanel = document.getElementById('versionHistory');
            
            if (documentVersions.length > 0) {
                historyPanel.style.display = 'block';
                
                let html = '';
                documentVersions.forEach((version, index) => {
                    const isActive = index === documentVersions.length - 1;
                    html += `
                        <div class="version-item" data-version="${version.id}">
                            <div class="version-info">
                                <div class="version-label">
                                    ÁâàÊú¨ ${version.id} ${isActive ? '(ÂΩìÂâç)' : ''}
                                </div>
                                <div class="version-meta">
                                    ${version.engine === 'openai' ? 'ChatGPT-4' : 'Deepseek'} ‚Ä¢ 
                                    ${formatTime(version.created_at)} ‚Ä¢ 
                                    ${getStatusText(version.status)}
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="loadVersion(${version.id})" ${isActive ? 'disabled' : ''}>
                                ${isActive ? 'ÂΩìÂâçÁâàÊú¨' : 'Êü•Áúã'}
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }
        
        // ËØÑ‰º∞Êñá‰π¶Ë¥®Èáè
        function evaluateQuality() {
            // Ê®°ÊãüË¥®ÈáèËØÑÂàÜ
            const score = Math.floor(Math.random() * 20) + 80;
            const details = [
                '‚úÖ Ê≥ïÊù°ÂºïÁî®ÂáÜÁ°Æ',
                '‚úÖ ÈÄªËæëÁªìÊûÑÊ∏ÖÊô∞',
                '‚úÖ ËØ≠Ë®ÄË°®Ëææ‰∏ì‰∏ö',
                score > 85 ? '‚úÖ Ê†ºÂºèËßÑËåÉÊ†áÂáÜ' : '‚ö†Ô∏è Ê†ºÂºèÈúÄË¶ÅË∞ÉÊï¥'
            ];
            
            document.getElementById('qualityScore').style.display = 'block';
            document.getElementById('scoreValue').textContent = score + 'ÂàÜ';
            document.getElementById('scoreDetails').textContent = details.join(' ‚Ä¢ ');
        }
        
        // ÈáçÊñ∞ÁîüÊàêÊñá‰π¶
        function regenerateDocument() {
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞ÁîüÊàêÊñá‰π¶ÂêóÔºüÂΩìÂâçÂÜÖÂÆπÂ∞ÜË¢´ÊõøÊç¢„ÄÇ')) {
                generateDocument();
            }
        }
        
        // ÁºñËæëÊñá‰π¶
        function editDocument() {
            const content = document.getElementById('documentOutput').textContent;
            const newContent = prompt('ÁºñËæëÊñá‰π¶ÂÜÖÂÆπÔºö', content);
            
            if (newContent && newContent !== content) {
                document.getElementById('documentOutput').textContent = newContent;
                currentDocument.content = newContent;
                
                // Ê∑ªÂä†ÁºñËæëÁâàÊú¨
                const version = {
                    id: documentVersions.length + 1,
                    content: newContent,
                    engine: 'manual_edit',
                    created_at: new Date(),
                    status: 'edited'
                };
                
                documentVersions.push(version);
                updateVersionHistory();
                
                showNotification('Êñá‰π¶Â∑≤Êõ¥Êñ∞', 'success');
            }
        }
        
        // È¢ÑËßàÊñá‰π¶
        function previewDocument() {
            const content = document.getElementById('documentOutput').textContent;
            
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>Êñá‰π¶È¢ÑËßà - ${currentTask.title}</title>
                    <style>
                        body { font-family: 'SimSun', serif; line-height: 1.8; padding: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .content { white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Ê≥ïÂæãÊñá‰π¶È¢ÑËßà</h1>
                        <p>ÁîüÊàêÊó∂Èó¥Ôºö${formatTime(new Date())}</p>
                    </div>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
        }
        
        // ÂÆ°Ê†∏ÈÄöËøá
        async function approveDocument() {
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            try {
                const response = await fetch('/api/v1/ai/approve-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        document_id: currentDocument.id,
                        task_id: currentTask.id,
                        review_notes: reviewNotes,
                        status: 'approved'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Êñá‰π¶ÂÆ°Ê†∏ÈÄöËøáÔºåÂ∑≤ËøõÂÖ•ÊâßË°åÈò∂ÊÆµ', 'success');
                    
                    // Ë∑≥ËΩ¨Âà∞‰ªªÂä°ÊâßË°åÈ°µÈù¢
                    setTimeout(() => {
                        window.location.href = `/task-execution.html?task_id=${currentTask.id}`;
                    }, 1500);
                } else {
                    throw new Error(result.message || 'ÂÆ°Ê†∏Â§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂÆ°Ê†∏Â§±Ë¥•:', error);
                showNotification('ÂÆ°Ê†∏Â§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        // Ë¶ÅÊ±Ç‰øÆÊîπ
        function requestModification() {
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            if (!reviewNotes.trim()) {
                showNotification('ËØ∑Â°´ÂÜô‰øÆÊîπÊÑèËßÅ', 'error');
                return;
            }
            
            // Ê†áËÆ∞‰∏∫ÈúÄË¶Å‰øÆÊîπ
            currentDocument.status = 'modification_requested';
            currentDocument.review_notes = reviewNotes;
            
            showNotification('Â∑≤Ë¶ÅÊ±Ç‰øÆÊîπÔºåËØ∑ÈáçÊñ∞ÁîüÊàêÊñá‰π¶', 'success');
        }
        
        // ÊãíÁªùÊñá‰π¶
        function rejectDocument() {
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            if (confirm('Á°ÆÂÆöË¶ÅÊãíÁªùËøô‰ªΩÊñá‰π¶ÂêóÔºü')) {
                showNotification('Êñá‰π¶Â∑≤Ë¢´ÊãíÁªù', 'error');
                
                // Ê∏ÖÁ©∫Êñá‰π¶ÂÜÖÂÆπ
                document.getElementById('documentOutput').className = 'document-output empty';
                document.getElementById('documentOutput').textContent = 'Êñá‰π¶Â∑≤Ë¢´ÊãíÁªùÔºåËØ∑ÈáçÊñ∞ÁîüÊàê';
                document.getElementById('documentActions').style.display = 'none';
                document.getElementById('reviewPanel').style.display = 'none';
            }
        }
        
        // Âä†ËΩΩÊ®°Êùø
        function loadTemplate(templateType) {
            const templates = {
                debt_collection: {
                    senderName: 'ÊüêÊüêÂæãÂ∏à‰∫ãÂä°ÊâÄ',
                    caseDescription: 'Ê†πÊçÆÂêàÂêåÁ∫¶ÂÆöÔºåÊÇ®Â∫î‰∫éÂêàÂêåËßÑÂÆöÊúüÈôêÂÜÖÊîØ‰ªòÁõ∏Â∫îÊ¨æÈ°πÔºå‰ΩÜÊà™Ëá≥ÁõÆÂâç‰ªçÊú™Â±•Ë°å‰ªòÊ¨æ‰πâÂä°„ÄÇ',
                    demands: '1. Á´ãÂç≥ÊîØ‰ªòÊ¨†Ê¨æÊú¨ÈáëÂèäÂà©ÊÅØ\n2. ÊâøÊãÖÁõ∏Â∫îÁöÑËøùÁ∫¶Ë¥£‰ªª\n3. ÊîØ‰ªòÂæãÂ∏àË¥πÁ≠âÁõ∏ÂÖ≥Ë¥πÁî®',
                    documentTone: 'formal_notice'
                },
                contract_breach: {
                    caseDescription: 'Ê†πÊçÆÂèåÊñπÁ≠æÁΩ≤ÁöÑÂêàÂêåÔºåÊÇ®Êú™ÊåâÁ∫¶ÂÆöÂ±•Ë°åÂêàÂêå‰πâÂä°ÔºåÊûÑÊàêËøùÁ∫¶„ÄÇ',
                    demands: '1. Á´ãÂç≥Á∫†Ê≠£ËøùÁ∫¶Ë°å‰∏∫\n2. ÊÅ¢Â§çÂêàÂêåÂ±•Ë°å\n3. ËµîÂÅøÁõ∏Â∫îÊçüÂ§±',
                    documentTone: 'stern_warning'
                },
                payment_reminder: {
                    caseDescription: 'Ê†πÊçÆÂêàÂêåÁ∫¶ÂÆöÁöÑ‰ªòÊ¨æÊúüÈôêÔºåÊÇ®ÁöÑ‰ªòÊ¨æÂ∑≤ÈÄæÊúü„ÄÇ',
                    demands: '1. ËØ∑‰∫éÊî∂ÂáΩÂêé7Êó•ÂÜÖÊîØ‰ªòÂà∞ÊúüÊ¨æÈ°π\n2. ÊîØ‰ªòÈÄæÊúüÂà©ÊÅØ',
                    documentTone: 'friendly_reminder'
                },
                infringement: {
                    caseDescription: 'ÊÇ®ÁöÑË°å‰∏∫Â∑≤ÊûÑÊàêÂØπÊàëÊñπÂêàÊ≥ïÊùÉÁõäÁöÑ‰æµÂÆ≥„ÄÇ',
                    demands: '1. Á´ãÂç≥ÂÅúÊ≠¢‰æµÊùÉË°å‰∏∫\n2. ÂÖ¨ÂºÄÈÅìÊ≠âÂπ∂Ê∂àÈô§ÂΩ±Âìç\n3. ËµîÂÅøÁªèÊµéÊçüÂ§±',
                    documentTone: 'legal_threat'
                }
            };
            
            const template = templates[templateType];
            if (template) {
                Object.keys(template).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = template[key];
                    }
                });
                
                showNotification('Ê®°ÊùøÂ∑≤Âä†ËΩΩ', 'success');
            }
        }
        
        // Âä†ËΩΩÊåáÂÆöÁâàÊú¨
        function loadVersion(versionId) {
            const version = documentVersions.find(v => v.id === versionId);
            if (version) {
                document.getElementById('documentOutput').textContent = version.content;
                currentDocument.content = version.content;
                showNotification(`Â∑≤ÂàáÊç¢Âà∞ÁâàÊú¨ ${versionId}`, 'success');
            }
        }
        
        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(date) {
            return date.toLocaleString('zh-CN');
        }
        
        // Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
        function getStatusText(status) {
            const statusMap = {
                'generated': 'Â∑≤ÁîüÊàê',
                'edited': 'ÊâãÂä®ÁºñËæë',
                'approved': 'Â∑≤ÈÄöËøá',
                'rejected': 'Â∑≤ÊãíÁªù'
            };
            return statusMap[status] || status;
        }
        
        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>