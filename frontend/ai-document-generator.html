<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ–‡ä¹¦ç”Ÿæˆå™¨ - Lawsker (å¾‹æ€å®¢)</title>
    <link rel="stylesheet" href="/css/lawsker-glass.css">
    <style>
        .generator-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .input-panel, .output-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            backdrop-filter: blur(10px);
            height: fit-content;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .task-info {
            background: rgba(248, 249, 250, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .task-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .task-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .ai-engine-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .engine-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .engine-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .engine-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .engine-option .engine-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .engine-option .engine-desc {
            font-size: 12px;
            color: #666;
        }
        
        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .document-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            font-family: 'SimSun', serif;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }
        
        .document-output.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }
        
        .document-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .quality-score {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        
        .score-details {
            font-size: 12px;
            color: #666;
        }
        
        .generating {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .review-panel {
            background: rgba(255, 243, 224, 0.8);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .version-history {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .version-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .version-item:last-child {
            border-bottom: none;
        }
        
        .version-info {
            flex: 1;
        }
        
        .version-label {
            font-weight: bold;
            color: #333;
        }
        
        .version-meta {
            font-size: 12px;
            color: #666;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        @media (max-width: 768px) {
            .generator-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIæ–‡ä¹¦ç”Ÿæˆå™¨</h1>
            <p>æ™ºèƒ½ç”Ÿæˆä¸“ä¸šæ³•å¾‹æ–‡ä¹¦ï¼Œå¾‹å¸ˆå®¡æ ¸ç¡®è®¤</p>
        </div>
        
        <div class="generator-container">
            <!-- è¾“å…¥é¢æ¿ -->
            <div class="input-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        ğŸ“ æ–‡ä¹¦ç”Ÿæˆè®¾ç½®
                    </div>
                </div>
                
                <!-- ä»»åŠ¡ä¿¡æ¯ -->
                <div class="task-info" id="taskInfo">
                    <h3>ğŸ“‹ å½“å‰ä»»åŠ¡</h3>
                    <div class="task-meta" id="taskMeta">
                        <div>ä»»åŠ¡ç±»å‹: <strong id="taskType">-</strong></div>
                        <div>é¢„ç®—: <strong id="taskBudget">-</strong></div>
                        <div>ç´§æ€¥ç¨‹åº¦: <strong id="taskUrgency">-</strong></div>
                        <div>åˆ›å»ºæ—¶é—´: <strong id="taskCreated">-</strong></div>
                    </div>
                </div>
                
                <!-- AIå¼•æ“é€‰æ‹© -->
                <div class="form-group">
                    <label>é€‰æ‹©AIå¼•æ“</label>
                    <div class="ai-engine-selector">
                        <div class="engine-option selected" data-engine="openai">
                            <div class="engine-name">ChatGPT-4</div>
                            <div class="engine-desc">é€»è¾‘ä¸¥å¯†ï¼Œä¸“ä¸šå‡†ç¡®</div>
                        </div>
                        <div class="engine-option" data-engine="deepseek">
                            <div class="engine-name">Deepseek</div>
                            <div class="engine-desc">ä¸­æ–‡ä¼˜åŒ–ï¼Œæœ¬åœŸåŒ–å¼º</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ–‡ä¹¦ç±»å‹ -->
                <div class="form-group">
                    <label for="documentType">æ–‡ä¹¦ç±»å‹</label>
                    <select id="documentType">
                        <option value="collection_letter">å€ºåŠ¡å‚¬æ”¶å‡½</option>
                        <option value="demand_letter">å¾‹å¸ˆå‡½</option>
                        <option value="warning_letter">è­¦å‘Šå‡½</option>
                        <option value="cease_desist">åœæ­¢ä¾µæƒå‡½</option>
                        <option value="breach_notice">è¿çº¦é€šçŸ¥ä¹¦</option>
                    </select>
                </div>
                
                <!-- è¯­è°ƒé£æ ¼ -->
                <div class="form-group">
                    <label for="documentTone">è¯­è°ƒé£æ ¼</label>
                    <select id="documentTone">
                        <option value="friendly_reminder">å‹å¥½æé†’</option>
                        <option value="formal_notice">æ­£å¼é€šçŸ¥</option>
                        <option value="stern_warning">ä¸¥å‰è­¦å‘Š</option>
                        <option value="legal_threat">æ³•å¾‹å¨æ…‘</option>
                    </select>
                </div>
                
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="form-group">
                    <label for="senderName">å‘å‡½æ–¹(å¾‹å¸ˆ/å¾‹æ‰€)</label>
                    <input type="text" id="senderName" placeholder="è¯·è¾“å…¥å¾‹å¸ˆæˆ–å¾‹æ‰€åç§°">
                </div>
                
                <div class="form-group">
                    <label for="recipientName">æ”¶å‡½æ–¹</label>
                    <input type="text" id="recipientName" placeholder="è¯·è¾“å…¥æ”¶å‡½æ–¹å§“åæˆ–å…¬å¸åç§°">
                </div>
                
                <div class="form-group">
                    <label for="caseAmount">æ¶‰åŠé‡‘é¢(å…ƒ)</label>
                    <input type="number" id="caseAmount" placeholder="å¦‚æœ‰é‡‘é¢äº‰è®®è¯·å¡«å†™">
                </div>
                
                <div class="form-group">
                    <label for="caseDescription">æ¡ˆæƒ…æè¿°</label>
                    <textarea id="caseDescription" placeholder="è¯·è¯¦ç»†æè¿°æ¡ˆä»¶èƒŒæ™¯ã€äº‰è®®ç„¦ç‚¹ã€äº‹å®ç»è¿‡ç­‰"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="legalBasis">æ³•å¾‹ä¾æ®</label>
                    <textarea id="legalBasis" placeholder="ç›¸å…³æ³•å¾‹æ¡æ–‡ï¼Œå¦‚ä¸å¡«å†™AIå°†è‡ªåŠ¨é€‰æ‹©"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="demands">å…·ä½“è¦æ±‚</label>
                    <textarea id="demands" placeholder="å¸Œæœ›å¯¹æ–¹é‡‡å–çš„å…·ä½“è¡ŒåŠ¨æˆ–å±¥è¡Œçš„ä¹‰åŠ¡"></textarea>
                </div>
                
                <button class="generate-btn" onclick="generateDocument()" id="generateBtn">
                    ğŸš€ ç”Ÿæˆæ–‡ä¹¦
                </button>
                
                <!-- æ¨¡æ¿åº“å¿«æ·æŒ‰é’® -->
                <div class="form-group">
                    <label>å¿«æ·æ¨¡æ¿</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="loadTemplate('debt_collection')">å€ºåŠ¡å‚¬æ”¶</button>
                        <button class="btn btn-secondary" onclick="loadTemplate('contract_breach')">åˆåŒè¿çº¦</button>
                        <button class="btn btn-secondary" onclick="loadTemplate('payment_reminder')">ä»˜æ¬¾æé†’</button>
                        <button class="btn btn-secondary" onclick="loadTemplate('infringement')">ä¾µæƒé€šçŸ¥</button>
                    </div>
                </div>
            </div>
            
            <!-- è¾“å‡ºé¢æ¿ -->
            <div class="output-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        ğŸ“„ ç”Ÿæˆç»“æœ
                    </div>
                    <div id="documentStatus" style="font-size: 12px; color: #666;"></div>
                </div>
                
                <!-- è´¨é‡è¯„åˆ† -->
                <div class="quality-score" id="qualityScore" style="display: none;">
                    <div class="score-header">
                        <span>ğŸ“Š æ–‡ä¹¦è´¨é‡è¯„åˆ†</span>
                        <span class="score-value" id="scoreValue">-</span>
                    </div>
                    <div class="score-details" id="scoreDetails">AIæ­£åœ¨è¯„ä¼°æ–‡ä¹¦è´¨é‡...</div>
                </div>
                
                <!-- æ–‡ä¹¦å†…å®¹ -->
                <div class="document-output empty" id="documentOutput">
                    ç‚¹å‡»"ç”Ÿæˆæ–‡ä¹¦"å¼€å§‹AIåˆ›ä½œ...
                </div>
                
                <!-- æ–‡ä¹¦æ“ä½œ -->
                <div class="document-actions" id="documentActions" style="display: none;">
                    <button class="btn btn-primary" onclick="regenerateDocument()">
                        ğŸ”„ é‡æ–°ç”Ÿæˆ
                    </button>
                    <button class="btn btn-warning" onclick="editDocument()">
                        âœï¸ æ‰‹åŠ¨ç¼–è¾‘
                    </button>
                    <button class="btn btn-secondary" onclick="previewDocument()">
                        ğŸ‘ï¸ é¢„è§ˆ
                    </button>
                    <button class="btn btn-success" onclick="approveDocument()">
                        âœ… å®¡æ ¸é€šè¿‡
                    </button>
                </div>
                
                <!-- å¾‹å¸ˆå®¡æ ¸é¢æ¿ -->
                <div class="review-panel" id="reviewPanel" style="display: none;">
                    <h4>âš–ï¸ å¾‹å¸ˆå®¡æ ¸</h4>
                    <p>è¯·ä»”ç»†å®¡æ ¸AIç”Ÿæˆçš„æ–‡ä¹¦å†…å®¹ï¼Œç¡®ä¿æ³•æ¡å¼•ç”¨å‡†ç¡®ã€é€»è¾‘æ¸…æ™°ã€æ ¼å¼è§„èŒƒã€‚</p>
                    <div class="form-group">
                        <label for="reviewNotes">å®¡æ ¸æ„è§</label>
                        <textarea id="reviewNotes" placeholder="è¯·å¡«å†™å®¡æ ¸æ„è§å’Œä¿®æ”¹å»ºè®®"></textarea>
                    </div>
                    <div class="review-actions">
                        <button class="btn btn-success" onclick="approveDocument()">
                            âœ… é€šè¿‡å®¡æ ¸
                        </button>
                        <button class="btn btn-warning" onclick="requestModification()">
                            ğŸ”„ è¦æ±‚ä¿®æ”¹
                        </button>
                        <button class="btn btn-secondary" onclick="rejectDocument()">
                            âŒ æ‹’ç»æ–‡ä¹¦
                        </button>
                    </div>
                </div>
                
                <!-- ç‰ˆæœ¬å†å² -->
                <div class="version-history" id="versionHistory" style="display: none;">
                    <h4>ğŸ“‹ ç‰ˆæœ¬å†å²</h4>
                    <div id="versionList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification"></div>

    <script>
        let currentTask = null;
        let currentDocument = null;
        let selectedEngine = 'openai';
        let documentVersions = [];
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            // ä»URLå‚æ•°è·å–ä»»åŠ¡ID
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('task_id');
            
            if (taskId) {
                loadTaskInfo(taskId);
            } else {
                // å¦‚æœæ²¡æœ‰ä»»åŠ¡IDï¼Œæ˜¾ç¤ºç¤ºä¾‹ä»»åŠ¡
                loadSampleTask();
            }
            
            // ç»‘å®šAIå¼•æ“é€‰æ‹©
            bindEngineSelector();
        });
        
        // ç»‘å®šAIå¼•æ“é€‰æ‹©å™¨
        function bindEngineSelector() {
            document.querySelectorAll('.engine-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.engine-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedEngine = this.dataset.engine;
                });
            });
        }
        
        // åŠ è½½ä»»åŠ¡ä¿¡æ¯
        async function loadTaskInfo(taskId) {
            try {
                const response = await fetch(`/api/v1/tasks/${taskId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    currentTask = await response.json();
                    displayTaskInfo();
                    prefillFormFromTask();
                } else {
                    throw new Error('åŠ è½½ä»»åŠ¡ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                showNotification('åŠ è½½ä»»åŠ¡ä¿¡æ¯å¤±è´¥', 'error');
                loadSampleTask();
            }
        }
        
        // åŠ è½½ç¤ºä¾‹ä»»åŠ¡
        function loadSampleTask() {
            currentTask = {
                task_type: 'collection_letter',
                title: 'å€ºåŠ¡å‚¬æ”¶æ¡ˆä»¶',
                budget: 1000,
                urgency: 'normal',
                created_at: new Date().toISOString(),
                description: 'æŸå…¬å¸æ‹–æ¬ è´§æ¬¾30ä¸‡å…ƒï¼Œéœ€è¦å‘å‡½å‚¬æ”¶',
                target_info: {
                    name: 'æŸæŸå…¬å¸',
                    amount: 300000
                }
            };
            displayTaskInfo();
            prefillFormFromTask();
        }
        
        // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
        function displayTaskInfo() {
            const taskTypeMap = {
                'collection_letter': 'å€ºåŠ¡å‚¬æ”¶',
                'demand_letter': 'å¾‹å¸ˆå‡½æœåŠ¡',
                'contract_review': 'åˆåŒå®¡æ ¸',
                'legal_consultation': 'æ³•å¾‹å’¨è¯¢'
            };
            
            const urgencyMap = {
                'normal': 'æ™®é€š',
                'urgent': 'ç´§æ€¥',
                'emergency': 'ç‰¹æ€¥'
            };
            
            document.getElementById('taskType').textContent = taskTypeMap[currentTask.task_type] || currentTask.task_type;
            document.getElementById('taskBudget').textContent = 'Â¥' + currentTask.budget;
            document.getElementById('taskUrgency').textContent = urgencyMap[currentTask.urgency] || currentTask.urgency;
            document.getElementById('taskCreated').textContent = formatDate(currentTask.created_at);
        }
        
        // ä»ä»»åŠ¡ä¿¡æ¯é¢„å¡«è¡¨å•
        function prefillFormFromTask() {
            if (currentTask.target_info) {
                document.getElementById('recipientName').value = currentTask.target_info.name || '';
                document.getElementById('caseAmount').value = currentTask.target_info.amount || '';
            }
            
            document.getElementById('caseDescription').value = currentTask.description || '';
            
            // æ ¹æ®ä»»åŠ¡ç±»å‹è®¾ç½®æ–‡ä¹¦ç±»å‹
            const typeMapping = {
                'collection_letter': 'collection_letter',
                'demand_letter': 'demand_letter'
            };
            
            const documentType = typeMapping[currentTask.task_type];
            if (documentType) {
                document.getElementById('documentType').value = documentType;
            }
        }
        
        // ç”Ÿæˆæ–‡ä¹¦
        async function generateDocument() {
            const formData = collectFormData();
            
            if (!validateFormData(formData)) {
                showNotification('è¯·å¡«å†™å¿…è¦ä¿¡æ¯', 'error');
                return;
            }
            
            // æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
            showGenerating();
            
            try {
                const response = await fetch('/api/v1/ai/generate-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        task_id: currentTask.id,
                        ai_engine: selectedEngine,
                        document_type: formData.documentType,
                        tone: formData.documentTone,
                        sender_name: formData.senderName,
                        recipient_name: formData.recipientName,
                        case_amount: formData.caseAmount,
                        case_description: formData.caseDescription,
                        legal_basis: formData.legalBasis,
                        demands: formData.demands
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentDocument = result.data;
                    displayDocument();
                    addDocumentVersion();
                    evaluateQuality();
                    showNotification('æ–‡ä¹¦ç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    throw new Error(result.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ–‡ä¹¦å¤±è´¥:', error);
                showNotification('ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
                hideGenerating();
            }
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            return {
                documentType: document.getElementById('documentType').value,
                documentTone: document.getElementById('documentTone').value,
                senderName: document.getElementById('senderName').value,
                recipientName: document.getElementById('recipientName').value,
                caseAmount: document.getElementById('caseAmount').value,
                caseDescription: document.getElementById('caseDescription').value,
                legalBasis: document.getElementById('legalBasis').value,
                demands: document.getElementById('demands').value
            };
        }
        
        // éªŒè¯è¡¨å•æ•°æ®
        function validateFormData(data) {
            return data.recipientName && data.caseDescription && data.demands;
        }
        
        // æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
        function showGenerating() {
            const output = document.getElementById('documentOutput');
            output.className = 'document-output';
            output.innerHTML = `
                <div class="generating">
                    <div class="spinner"></div>
                    <p>AIæ­£åœ¨ç”Ÿæˆæ–‡ä¹¦ï¼Œè¯·ç¨å€™...</p>
                    <p style="font-size: 12px; color: #999;">
                        ä½¿ç”¨${selectedEngine === 'openai' ? 'ChatGPT-4' : 'Deepseek'}å¼•æ“
                    </p>
                </div>
            `;
            
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('documentActions').style.display = 'none';
        }
        
        // éšè—ç”Ÿæˆä¸­çŠ¶æ€
        function hideGenerating() {
            document.getElementById('generateBtn').disabled = false;
        }
        
        // æ˜¾ç¤ºæ–‡ä¹¦å†…å®¹
        function displayDocument() {
            const output = document.getElementById('documentOutput');
            output.className = 'document-output';
            output.textContent = currentDocument.content || 'ç”Ÿæˆçš„æ–‡ä¹¦å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
            
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('documentActions').style.display = 'flex';
            document.getElementById('reviewPanel').style.display = 'block';
            document.getElementById('documentStatus').textContent = `AIå¼•æ“ï¼š${selectedEngine === 'openai' ? 'ChatGPT-4' : 'Deepseek'} | ç”Ÿæˆæ—¶é—´ï¼š${formatTime(new Date())}`;
        }
        
        // æ·»åŠ æ–‡ä¹¦ç‰ˆæœ¬
        function addDocumentVersion() {
            const version = {
                id: documentVersions.length + 1,
                content: currentDocument.content,
                engine: selectedEngine,
                created_at: new Date(),
                status: 'generated'
            };
            
            documentVersions.push(version);
            updateVersionHistory();
        }
        
        // æ›´æ–°ç‰ˆæœ¬å†å²
        function updateVersionHistory() {
            const container = document.getElementById('versionList');
            const historyPanel = document.getElementById('versionHistory');
            
            if (documentVersions.length > 0) {
                historyPanel.style.display = 'block';
                
                let html = '';
                documentVersions.forEach((version, index) => {
                    const isActive = index === documentVersions.length - 1;
                    html += `
                        <div class="version-item" data-version="${version.id}">
                            <div class="version-info">
                                <div class="version-label">
                                    ç‰ˆæœ¬ ${version.id} ${isActive ? '(å½“å‰)' : ''}
                                </div>
                                <div class="version-meta">
                                    ${version.engine === 'openai' ? 'ChatGPT-4' : 'Deepseek'} â€¢ 
                                    ${formatTime(version.created_at)} â€¢ 
                                    ${getStatusText(version.status)}
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="loadVersion(${version.id})" ${isActive ? 'disabled' : ''}>
                                ${isActive ? 'å½“å‰ç‰ˆæœ¬' : 'æŸ¥çœ‹'}
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }
        
        // è¯„ä¼°æ–‡ä¹¦è´¨é‡
        function evaluateQuality() {
            // æ¨¡æ‹Ÿè´¨é‡è¯„åˆ†
            const score = Math.floor(Math.random() * 20) + 80;
            const details = [
                'âœ… æ³•æ¡å¼•ç”¨å‡†ç¡®',
                'âœ… é€»è¾‘ç»“æ„æ¸…æ™°',
                'âœ… è¯­è¨€è¡¨è¾¾ä¸“ä¸š',
                score > 85 ? 'âœ… æ ¼å¼è§„èŒƒæ ‡å‡†' : 'âš ï¸ æ ¼å¼éœ€è¦è°ƒæ•´'
            ];
            
            document.getElementById('qualityScore').style.display = 'block';
            document.getElementById('scoreValue').textContent = score + 'åˆ†';
            document.getElementById('scoreDetails').textContent = details.join(' â€¢ ');
        }
        
        // é‡æ–°ç”Ÿæˆæ–‡ä¹¦
        function regenerateDocument() {
            if (confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆæ–‡ä¹¦å—ï¼Ÿå½“å‰å†…å®¹å°†è¢«æ›¿æ¢ã€‚')) {
                generateDocument();
            }
        }
        
        // ç¼–è¾‘æ–‡ä¹¦
        function editDocument() {
            const content = document.getElementById('documentOutput').textContent;
            const newContent = prompt('ç¼–è¾‘æ–‡ä¹¦å†…å®¹ï¼š', content);
            
            if (newContent && newContent !== content) {
                document.getElementById('documentOutput').textContent = newContent;
                currentDocument.content = newContent;
                
                // æ·»åŠ ç¼–è¾‘ç‰ˆæœ¬
                const version = {
                    id: documentVersions.length + 1,
                    content: newContent,
                    engine: 'manual_edit',
                    created_at: new Date(),
                    status: 'edited'
                };
                
                documentVersions.push(version);
                updateVersionHistory();
                
                showNotification('æ–‡ä¹¦å·²æ›´æ–°', 'success');
            }
        }
        
        // é¢„è§ˆæ–‡ä¹¦
        function previewDocument() {
            const content = document.getElementById('documentOutput').textContent;
            
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>æ–‡ä¹¦é¢„è§ˆ - ${currentTask.title}</title>
                    <style>
                        body { font-family: 'SimSun', serif; line-height: 1.8; padding: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .content { white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>æ³•å¾‹æ–‡ä¹¦é¢„è§ˆ</h1>
                        <p>ç”Ÿæˆæ—¶é—´ï¼š${formatTime(new Date())}</p>
                    </div>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
        }
        
        // å®¡æ ¸é€šè¿‡
        async function approveDocument() {
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            try {
                const response = await fetch('/api/v1/ai/approve-document', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        document_id: currentDocument.id,
                        task_id: currentTask.id,
                        review_notes: reviewNotes,
                        status: 'approved'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('æ–‡ä¹¦å®¡æ ¸é€šè¿‡ï¼Œå·²è¿›å…¥æ‰§è¡Œé˜¶æ®µ', 'success');
                    
                    // è·³è½¬åˆ°ä»»åŠ¡æ‰§è¡Œé¡µé¢
                    setTimeout(() => {
                        window.location.href = `/task-execution.html?task_id=${currentTask.id}`;
                    }, 1500);
                } else {
                    throw new Error(result.message || 'å®¡æ ¸å¤±è´¥');
                }
            } catch (error) {
                console.error('å®¡æ ¸å¤±è´¥:', error);
                showNotification('å®¡æ ¸å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // è¦æ±‚ä¿®æ”¹
        function requestModification() {
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            if (!reviewNotes.trim()) {
                showNotification('è¯·å¡«å†™ä¿®æ”¹æ„è§', 'error');
                return;
            }
            
            // æ ‡è®°ä¸ºéœ€è¦ä¿®æ”¹
            currentDocument.status = 'modification_requested';
            currentDocument.review_notes = reviewNotes;
            
            showNotification('å·²è¦æ±‚ä¿®æ”¹ï¼Œè¯·é‡æ–°ç”Ÿæˆæ–‡ä¹¦', 'success');
        }
        
        // æ‹’ç»æ–‡ä¹¦
        function rejectDocument() {
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            if (confirm('ç¡®å®šè¦æ‹’ç»è¿™ä»½æ–‡ä¹¦å—ï¼Ÿ')) {
                showNotification('æ–‡ä¹¦å·²è¢«æ‹’ç»', 'error');
                
                // æ¸…ç©ºæ–‡ä¹¦å†…å®¹
                document.getElementById('documentOutput').className = 'document-output empty';
                document.getElementById('documentOutput').textContent = 'æ–‡ä¹¦å·²è¢«æ‹’ç»ï¼Œè¯·é‡æ–°ç”Ÿæˆ';
                document.getElementById('documentActions').style.display = 'none';
                document.getElementById('reviewPanel').style.display = 'none';
            }
        }
        
        // åŠ è½½æ¨¡æ¿
        function loadTemplate(templateType) {
            const templates = {
                debt_collection: {
                    senderName: 'æŸæŸå¾‹å¸ˆäº‹åŠ¡æ‰€',
                    caseDescription: 'æ ¹æ®åˆåŒçº¦å®šï¼Œæ‚¨åº”äºåˆåŒè§„å®šæœŸé™å†…æ”¯ä»˜ç›¸åº”æ¬¾é¡¹ï¼Œä½†æˆªè‡³ç›®å‰ä»æœªå±¥è¡Œä»˜æ¬¾ä¹‰åŠ¡ã€‚',
                    demands: '1. ç«‹å³æ”¯ä»˜æ¬ æ¬¾æœ¬é‡‘åŠåˆ©æ¯\n2. æ‰¿æ‹…ç›¸åº”çš„è¿çº¦è´£ä»»\n3. æ”¯ä»˜å¾‹å¸ˆè´¹ç­‰ç›¸å…³è´¹ç”¨',
                    documentTone: 'formal_notice'
                },
                contract_breach: {
                    caseDescription: 'æ ¹æ®åŒæ–¹ç­¾ç½²çš„åˆåŒï¼Œæ‚¨æœªæŒ‰çº¦å®šå±¥è¡ŒåˆåŒä¹‰åŠ¡ï¼Œæ„æˆè¿çº¦ã€‚',
                    demands: '1. ç«‹å³çº æ­£è¿çº¦è¡Œä¸º\n2. æ¢å¤åˆåŒå±¥è¡Œ\n3. èµ”å¿ç›¸åº”æŸå¤±',
                    documentTone: 'stern_warning'
                },
                payment_reminder: {
                    caseDescription: 'æ ¹æ®åˆåŒçº¦å®šçš„ä»˜æ¬¾æœŸé™ï¼Œæ‚¨çš„ä»˜æ¬¾å·²é€¾æœŸã€‚',
                    demands: '1. è¯·äºæ”¶å‡½å7æ—¥å†…æ”¯ä»˜åˆ°æœŸæ¬¾é¡¹\n2. æ”¯ä»˜é€¾æœŸåˆ©æ¯',
                    documentTone: 'friendly_reminder'
                },
                infringement: {
                    caseDescription: 'æ‚¨çš„è¡Œä¸ºå·²æ„æˆå¯¹æˆ‘æ–¹åˆæ³•æƒç›Šçš„ä¾µå®³ã€‚',
                    demands: '1. ç«‹å³åœæ­¢ä¾µæƒè¡Œä¸º\n2. å…¬å¼€é“æ­‰å¹¶æ¶ˆé™¤å½±å“\n3. èµ”å¿ç»æµæŸå¤±',
                    documentTone: 'legal_threat'
                }
            };
            
            const template = templates[templateType];
            if (template) {
                Object.keys(template).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = template[key];
                    }
                });
                
                showNotification('æ¨¡æ¿å·²åŠ è½½', 'success');
            }
        }
        
        // åŠ è½½æŒ‡å®šç‰ˆæœ¬
        function loadVersion(versionId) {
            const version = documentVersions.find(v => v.id === versionId);
            if (version) {
                document.getElementById('documentOutput').textContent = version.content;
                currentDocument.content = version.content;
                showNotification(`å·²åˆ‡æ¢åˆ°ç‰ˆæœ¬ ${versionId}`, 'success');
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            return date.toLocaleString('zh-CN');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'generated': 'å·²ç”Ÿæˆ',
                'edited': 'æ‰‹åŠ¨ç¼–è¾‘',
                'approved': 'å·²é€šè¿‡',
                'rejected': 'å·²æ‹’ç»'
            };
            return statusMap[status] || status;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>